<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×’×"×— ×•×•×™×– - ××©×¤' ×¦×“×§×”</title>
<link rel="icon" type="image/png" href="logo.png">
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
    --primary:#0077B6;
    --primary-light:#00A8E8;
    --primary-dark:#005A8D;
    --secondary:#48CAE4;
    --dark:#1A1A2E;
    --dark-light:#2D2D44;
    --success:#10B981;
    --warning:#F59E0B;
    --danger:#EF4444;
    --gray-50:#F9FAFB;
    --gray-100:#F3F4F6;
    --gray-200:#E5E7EB;
    --gray-300:#D1D5DB;
    --gray-400:#9CA3AF;
    --gray-500:#6B7280;
    --gray-600:#4B5563;
    --gray-700:#374151;
    --white:#FFFFFF;
    --shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Heebo',sans-serif;background:var(--gray-100);min-height:100vh;color:var(--dark)}
.app{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{width:240px;background:var(--dark);color:var(--white);position:fixed;height:100vh;overflow-y:auto;transition:transform .3s}
.sidebar-header{padding:20px;border-bottom:1px solid var(--dark-light);text-align:center}
.sidebar-header img{width:100%;max-width:180px;height:auto;border-radius:8px;object-fit:contain;margin-bottom:12px;display:block;margin-left:auto;margin-right:auto}
.sidebar-header h1{font-size:18px;font-weight:600;margin:0}
.sidebar-header span{font-size:12px;color:var(--gray-400);display:block;margin-top:5px}
.sidebar-nav{padding:15px 0}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 20px;color:var(--gray-300);cursor:pointer;transition:.2s;border-right:3px solid transparent}
.nav-item:hover{background:var(--dark-light);color:var(--white)}
.nav-item.active{background:var(--dark-light);color:var(--primary-light);border-right-color:var(--primary-light)}
.nav-item i{width:20px;text-align:center}
.nav-divider{height:1px;background:var(--dark-light);margin:10px 20px}

/* Main Content */
.main{flex:1;margin-right:240px;padding:20px 30px;display:flex;flex-direction:column;min-height:100vh}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
.page-title{font-size:24px;font-weight:600;color:var(--dark)}
.topbar-actions{display:flex;gap:10px;align-items:center}
.search-input{padding:10px 15px;border:1px solid var(--gray-300);border-radius:8px;width:280px;font-size:14px;background:var(--white)}
.search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,119,182,0.1)}

/* Buttons */
.btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{transform:translateY(-1px)}
.btn-primary{background:var(--primary);color:var(--white)}
.btn-primary:hover{background:var(--primary-dark)}
.btn-success{background:var(--success);color:var(--white)}
.btn-danger{background:var(--danger);color:var(--white)}
.btn-warning{background:var(--warning);color:var(--dark)}
.btn-outline{background:transparent;border:1px solid var(--gray-300);color:var(--gray-600)}
.btn-outline:hover{background:var(--gray-100)}
.btn-sm{padding:6px 12px;font-size:13px}
.btn-icon{width:36px;height:36px;padding:0;justify-content:center}

/* Cards */
.card{background:var(--white);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
.card-header{padding:16px 20px;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center}
.card-title{font-size:16px;font-weight:600}
.card-body{padding:20px}

/* Stats Grid */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:25px}
.stat-card{background:var(--white);border-radius:12px;padding:20px;box-shadow:var(--shadow);display:flex;align-items:center;gap:15px;cursor:pointer;transition:.2s}
.stat-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
.stat-icon{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px}
.stat-icon.blue{background:rgba(0,119,182,0.1);color:var(--primary)}
.stat-icon.green{background:rgba(16,185,129,0.1);color:var(--success)}
.stat-icon.orange{background:rgba(245,158,11,0.1);color:var(--warning)}
.stat-icon.red{background:rgba(239,68,68,0.1);color:var(--danger)}
.stat-info h3{font-size:28px;font-weight:700;color:var(--dark)}
.stat-info p{font-size:13px;color:var(--gray-500)}

/* Tables */
table{width:100%;border-collapse:collapse}
th,td{padding:12px 15px;text-align:right;font-size:14px}
th{background:var(--gray-50);color:var(--gray-600);font-weight:600;border-bottom:2px solid var(--gray-200)}
td{border-bottom:1px solid var(--gray-200)}
tr:hover td{background:var(--gray-50)}
.status-badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500}
.status-available{background:#D1FAE5;color:#065F46}
.status-rented{background:#DBEAFE;color:#1E40AF}
.status-repair{background:#FEE2E2;color:#991B1B}
.status-overdue{background:#FEE2E2;color:#991B1B}

/* Form */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;font-weight:500;color:var(--gray-700);margin-bottom:6px}
.form-group label.required::after{content:" *";color:var(--danger)}
.form-control{width:100%;padding:10px 12px;border:1px solid var(--gray-300);border-radius:8px;font-size:14px;transition:.2s}
.form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,119,182,0.1)}
.form-check{display:flex;align-items:center;gap:8px;margin:5px 0}
.form-check input{width:18px;height:18px}
.checkbox-grid{display:flex;flex-wrap:wrap;gap:15px}

/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}
.modal-content{background:var(--white);border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{padding:20px;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-size:18px;font-weight:600}
.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray-400)}
.modal-body{padding:20px}
.modal-footer{padding:15px 20px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:10px}

/* Tabs */
.tabs{display:flex;gap:5px;margin-bottom:20px;border-bottom:2px solid var(--gray-200);padding-bottom:-2px}
.tab{padding:10px 20px;border:none;background:none;cursor:pointer;font-size:14px;color:var(--gray-500);border-bottom:2px solid transparent;margin-bottom:-2px;transition:.2s}
.tab:hover{color:var(--gray-700)}
.tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:500}

/* Rental Cards */
.rental-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:15px}
.rental-card{background:var(--white);border-radius:12px;padding:18px;box-shadow:var(--shadow);border-right:4px solid var(--success)}
.rental-card.overdue{border-right-color:var(--danger);background:#FEF2F2}
.rental-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.rental-customer{font-weight:600;font-size:16px}
.rental-device{font-size:13px;color:var(--gray-500)}
.rental-dates{font-size:13px;color:var(--gray-600);margin:8px 0}
.rental-hebrew{font-size:11px;color:var(--gray-400)}
.rental-actions{display:flex;gap:8px;margin-top:12px}

/* Calendar */
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.calendar-header{padding:10px;text-align:center;font-weight:600;font-size:13px;color:var(--gray-600);background:var(--gray-100)}
.calendar-day{padding:10px;min-height:80px;background:var(--white);border:1px solid var(--gray-200);font-size:13px}
.calendar-day.today{background:#EFF6FF;border-color:var(--primary)}
.calendar-day-num{font-weight:600;margin-bottom:5px}
.calendar-event{font-size:11px;padding:2px 5px;background:var(--primary);color:white;border-radius:3px;margin:2px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
.calendar-event.past{background:var(--gray-300);color:var(--gray-600)}
.calendar-day{cursor:pointer;transition:background .2s}
.calendar-day:hover{background:var(--gray-50)}
.highlight-row{background:#FFF3CD !important;animation:highlight-pulse 1s ease-in-out 3}

/* Alerts */
.alert{padding:12px 16px;border-radius:8px;margin-bottom:15px;display:flex;align-items:center;gap:10px;font-size:14px}
.alert-warning{background:#FEF3C7;color:#92400E;border:1px solid #FCD34D}
.alert-danger{background:#FEE2E2;color:#991B1B;border:1px solid #FCA5A5}
.alert-success{background:#D1FAE5;color:#065F46;border:1px solid #6EE7B7}

/* Page visibility */
.page{display:none;flex:1}
.page.active{display:block}

/* Footer */
.footer{background:var(--white);border-top:1px solid var(--gray-200);padding:15px 30px;text-align:center;font-size:12px;color:var(--gray-500);margin-top:auto}
.footer a{color:var(--primary);text-decoration:none}
.footer a:hover{text-decoration:underline}

/* Login Screen */
.login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--primary),var(--primary-dark));display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:var(--white);padding:40px;border-radius:16px;box-shadow:var(--shadow-lg);max-width:400px;width:90%;text-align:center}
.login-box img{max-width:200px;width:100%;height:auto;border-radius:8px;margin-bottom:20px;object-fit:contain}
.login-box h2{margin-bottom:10px;color:var(--dark)}
.login-box p{color:var(--gray-600);margin-bottom:20px}
.login-box .form-group{margin-bottom:15px}
.login-box .btn{width:100%}
.hidden{display:none !important}

/* Highlight animation */
@keyframes highlight-pulse {
    0%, 100% { background: #FFF3CD; }
    50% { background: #FFE69C; }
}

/* Tooltip */
.calendar-tooltip{position:absolute;background:var(--dark);color:white;padding:8px 12px;border-radius:6px;font-size:12px;z-index:100;white-space:nowrap;pointer-events:none}

/* Responsive */
@media(max-width:900px){
    .sidebar{transform:translateX(100%)}
    .sidebar.open{transform:translateX(0)}
    .main{margin-right:0}
}

/* Empty state */
.empty-state{text-align:center;padding:40px;color:var(--gray-500)}
.empty-state-icon{font-size:48px;margin-bottom:15px;opacity:0.5}

/* Quick actions */
.quick-actions{display:flex;gap:12px;margin-bottom:25px}
.quick-action{flex:1;padding:20px;background:var(--white);border-radius:12px;box-shadow:var(--shadow);display:flex;align-items:center;gap:15px;cursor:pointer;transition:.2s}
.quick-action:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
.quick-action.primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:var(--white)}
.quick-action.danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:var(--white)}
.quick-action-icon{font-size:28px}
.quick-action-text h4{font-size:16px;font-weight:600}
.quick-action-text p{font-size:12px;opacity:0.8}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen hidden">
<div class="login-box">
<img src="×œ×•×’×•.jpg" alt="×œ×•×’×• ×’×"×— ×•×•×™×–">
<h2>×’×"×— ×•×•×™×– - ××©×¤' ×¦×“×§×”</h2>
<p>×”×–×Ÿ ×¡×™×¡××” ×œ×›× ×™×¡×” ×œ××¢×¨×›×ª</p>
<div class="form-group">
<input type="password" class="form-control" id="loginPassword" placeholder="×¡×™×¡××”..." onkeypress="if(event.key==='Enter') checkPassword()">
</div>
<button class="btn btn-primary" onclick="checkPassword()">ğŸ”“ ×›× ×™×¡×”</button>
</div>
</div>

<div class="app">
<!-- Sidebar -->
<aside class="sidebar">
<div class="sidebar-header">
<img src="×œ×•×’×•.jpg" alt="×œ×•×’×• ×’×"×— ×•×•×™×–">
<h1>×’×"×— ×•×•×™×–</h1>
<span>××©×¤' ×¦×“×§×”</span>
</div>
<nav class="sidebar-nav">
<div class="nav-item active" onclick="showPage('dashboard')">ğŸ“Š ×œ×•×— ×‘×§×¨×”</div>
<div class="nav-item" onclick="showPage('newRental')">â• ×”×©×›×¨×” ×—×“×©×”</div>
<div class="nav-item" onclick="showPage('rentals')">ğŸ“‹ ×”×©×›×¨×•×ª</div>
<div class="nav-item" onclick="showPage('calendar')">ğŸ“… ×œ×•×— ×©× ×”</div>
<div class="nav-divider"></div>
<div class="nav-item" onclick="showPage('devices')">ğŸ“± ××›×©×™×¨×™×</div>
<div class="nav-item" onclick="showPage('customers')">ğŸ‘¥ ×œ×§×•×—×•×ª</div>
<div class="nav-item" onclick="showPage('waitlist')">â³ ×¨×©×™××ª ×”××ª× ×”</div>
<div class="nav-divider"></div>
<div class="nav-item" onclick="showPage('expenses')">ğŸ’¸ ×”×•×¦××•×ª ×•×”×›× ×¡×•×ª</div>
<div class="nav-item" onclick="showPage('reports')">ğŸ“ˆ ×“×•×—×•×ª</div>
<div class="nav-item" onclick="showPage('instructions')">ğŸ“œ ×”×•×¨××•×ª ×”×’×"×—</div>
<div class="nav-item" onclick="showPage('settings')">âš™ï¸ ×”×’×“×¨×•×ª</div>
</nav>
</aside>

<!-- Main Content -->
<main class="main">

<!-- Dashboard -->
<div id="dashboard" class="page active">
<div class="topbar">
<h1 class="page-title">×œ×•×— ×‘×§×¨×”</h1>
<div class="topbar-actions">
<input type="text" class="search-input" placeholder="×—×™×¤×•×© ××”×™×¨..." oninput="globalSearch(this.value)">
</div>
</div>

<div class="quick-actions">
<div class="quick-action primary" onclick="showPage('newRental')">
<span class="quick-action-icon">â•</span>
<div class="quick-action-text">
<h4>×”×©×›×¨×” ×—×“×©×”</h4>
<p>×”×ª×—×œ ×”×©×›×¨×” ×—×“×©×”</p>
</div>
</div>
<div class="quick-action danger" onclick="openEndRentalModal()">
<span class="quick-action-icon">ğŸ“¥</span>
<div class="quick-action-text">
<h4>×¡×™×•× ×”×©×›×¨×”</h4>
<p>×”×—×–×¨ ××›×©×™×¨</p>
</div>
</div>
</div>

<div class="stats-grid" id="statsContainer"></div>

<div class="card">
<div class="card-header">
<h3 class="card-title">ğŸ“‹ ×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª</h3>
</div>
<div class="card-body">
<div class="rental-grid" id="activeRentalsGrid"></div>
</div>
</div>
</div>

<!-- New Rental -->
<div id="newRental" class="page">
<div class="topbar">
<h1 class="page-title">×”×©×›×¨×” ×—×“×©×”</h1>
</div>
<div class="card">
<div class="card-body">
<form id="rentalForm" onsubmit="return createRental(event)">
<div class="form-grid">
<div class="form-group autocomplete">
<label class="required">×©× ×œ×§×•×—</label>
<input type="text" class="form-control" id="customerName" required oninput="searchCustomers(this.value)" autocomplete="off">
<div id="customerSuggestions" style="position:absolute;background:white;border:1px solid var(--gray-300);border-radius:8px;max-height:150px;overflow-y:auto;display:none;z-index:10;width:100%"></div>
</div>
<div class="form-group">
<label class="required">×˜×œ×¤×•×Ÿ</label>
<input type="tel" class="form-control" id="customerPhone" required>
<button type="button" class="btn btn-sm btn-outline" style="margin-top:8px" onclick="openCustomerModal(null, true)">â• ×”×•×¡×£ ×›×œ×§×•×— ×—×“×©</button>
</div>
<div class="form-group">
<label class="required">××›×©×™×¨</label>
<select class="form-control" id="deviceSelect" required></select>
</div>
<div class="form-group">
<label>××©×š ×”×©×›×¨×”</label>
<select class="form-control" id="rentalDuration" onchange="updateReturnDate()">
<option value="hours">×›××” ×©×¢×•×ª</option>
<option value="evening">×¢×“ ×”×¢×¨×‘</option>
<option value="morning">×¢×“ ××—×¨ ×‘×‘×•×§×¨</option>
<option value="1">×™×•× ××—×“</option>
<option value="2">×™×•××™×™×</option>
<option value="3">3 ×™××™×</option>
<option value="5">5 ×™××™×</option>
<option value="7">×©×‘×•×¢</option>
<option value="14">×©×‘×•×¢×™×™×</option>
<option value="custom">×ª××¨×™×š ×¡×¤×¦×™×¤×™</option>
</select>
</div>
<div class="form-group" id="hoursGroup" style="display:none">
<label>×©×¢×ª ×”×—×–×¨×” ××©×•×¢×¨×ª</label>
<input type="time" class="form-control" id="returnTime" value="18:00">
</div>
<div class="form-group" id="customDateGroup" style="display:none">
<label>×ª××¨×™×š ×”×—×–×¨×”</label>
<input type="date" class="form-control" id="customReturnDate">
</div>
<div class="form-group">
<label>××—×™×¨ (â‚ª)</label>
<input type="number" class="form-control" id="rentalPrice" value="10">
</div>
</div>

<div class="form-group">
<label>×¦×™×•×“ × ×œ×•×•×”</label>
<div class="checkbox-grid">
<label class="form-check"><input type="checkbox" id="accCable" checked> ×›×‘×œ ×˜×¢×™× ×”</label>
<label class="form-check"><input type="checkbox" id="accCarCharger" checked> ××¦×ª ×œ×¨×›×‘</label>
<label class="form-check"><input type="checkbox" id="accMagnet"> ××’× ×˜</label>
<label class="form-check"><input type="checkbox" id="accArm"> ×–×¨×•×¢ ×œ×¨×›×‘</label>
<label class="form-check"><input type="checkbox" id="accOther" onchange="toggleOtherAccessory()"> ××—×¨</label>
</div>
<div class="form-group" id="otherAccessoryGroup" style="display:none;margin-top:10px">
<label>×¤×¨×˜ ××•×¦×¨ × ×•×¡×£</label>
<input type="text" class="form-control" id="accOtherText" placeholder="×”×§×œ×“ ××•×¦×¨ × ×•×¡×£...">
</div>
</div>


<div class="form-group">
<label>×”×¢×¨×•×ª</label>
<textarea class="form-control" id="rentalNotes" rows="2"></textarea>
</div>

<div style="display:flex;gap:10px;margin-top:20px">
<button type="submit" class="btn btn-success">âœ… ××©×¨ ×”×©×›×¨×”</button>
<button type="button" class="btn btn-outline" onclick="clearRentalForm()">× ×§×” ×˜×•×¤×¡</button>
</div>
</form>
</div>
</div>
</div>

<!-- Rentals -->
<div id="rentals" class="page">
<div class="topbar">
<h1 class="page-title">× ×™×”×•×œ ×”×©×›×¨×•×ª</h1>
</div>
<div class="card">
<div class="card-body">
<div class="tabs">
<button class="tab active" onclick="filterRentals('active')">×¤×¢×™×œ×•×ª</button>
<button class="tab" onclick="filterRentals('overdue')">×‘××™×—×•×¨</button>
<button class="tab" onclick="filterRentals('returned')">×”×•×—×–×¨×•</button>
<button class="tab" onclick="filterRentals('all')">×”×›×œ</button>
</div>
<div class="rental-grid" id="rentalsGrid"></div>
</div>
</div>
</div>

<!-- Calendar -->
<div id="calendar" class="page">
<div class="topbar">
<h1 class="page-title">ğŸ“… ×œ×•×— ×©× ×”</h1>
<div class="topbar-actions">
<button class="btn btn-outline" onclick="changeMonth(-1)">â—€ ×—×•×“×© ×§×•×“×</button>
<span id="currentMonth" style="padding:0 15px;font-weight:600"></span>
<button class="btn btn-outline" onclick="changeMonth(1)">×—×•×“×© ×”×‘× â–¶</button>
</div>
</div>
<div class="card">
<div class="card-body">
<div class="calendar-grid" id="calendarGrid"></div>
</div>
</div>
</div>

<!-- Devices -->
<div id="devices" class="page">
<div class="topbar">
<h1 class="page-title">× ×™×”×•×œ ××›×©×™×¨×™×</h1>
<div class="topbar-actions">
<button class="btn btn-primary" onclick="openDeviceModal()">â• ×”×•×¡×£ ××›×©×™×¨</button>
<button class="btn btn-outline" onclick="exportToExcel('devices')">ğŸ“Š ×™×™×¦×•×</button>
</div>
</div>
<div class="card">
<div class="card-body">
<div class="tabs">
<button class="tab active" onclick="filterDevices('all')">×”×›×œ</button>
<button class="tab" onclick="filterDevices('available')">×–××™× ×™×</button>
<button class="tab" onclick="filterDevices('rented')">××•×©×›×¨×™×</button>
<button class="tab" onclick="filterDevices('repair')">×‘×ª×™×§×•×Ÿ</button>
</div>
<table>
<thead><tr><th>××¡×¤×¨</th><th>×“×’×</th><th>×¡×•×’</th><th>××—×™×¨</th><th>×¡×˜×˜×•×¡</th><th>×¡×•×œ×œ×”</th><th>SIM</th><th>×”×›× ×¡×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
<tbody id="devicesTable"></tbody>
</table>
</div>
</div>
</div>

<!-- Customers -->
<div id="customers" class="page">
<div class="topbar">
<h1 class="page-title">× ×™×”×•×œ ×œ×§×•×—×•×ª</h1>
<div class="topbar-actions">
<button class="btn btn-primary" onclick="openCustomerModal()">â• ×”×•×¡×£ ×œ×§×•×—</button>
<button class="btn btn-outline" onclick="exportToExcel('customers')">ğŸ“Š ×™×™×¦×•×</button>
</div>
</div>
<div class="card">
<div class="card-body">
<div class="tabs">
<button class="tab active" onclick="filterCustomers('all')">×”×›×œ</button>
<button class="tab" onclick="filterCustomers('debt')">×—×™×™×‘×™×</button>
<button class="tab" onclick="filterCustomers('subscription')">×× ×•×™×™×</button>
</div>
<table>
<thead><tr><th>×©×</th><th>×˜×œ×¤×•×Ÿ</th><th>×”×©×›×¨×•×ª</th><th>×©×™×œ× ×¡×”"×›</th><th>×—×•×‘</th><th>×× ×•×™ (×™××™×)</th><th>×”×¢×¨×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
<tbody id="customersTable"></tbody>
</table>
</div>
</div>
</div>

<!-- Waitlist -->
<div id="waitlist" class="page">
<div class="topbar">
<h1 class="page-title">×¨×©×™××ª ×”××ª× ×”</h1>
<div class="topbar-actions">
<button class="btn btn-primary" onclick="openWaitlistModal()">â• ×”×•×¡×£ ×œ×ª×•×¨</button>
</div>
</div>
<div class="card">
<div class="card-body">
<table>
<thead><tr><th>×©×</th><th>×˜×œ×¤×•×Ÿ</th><th>×ª××¨×™×š ×¨×™×©×•×</th><th>×¡×•×’ ××‘×•×§×©</th><th>×”×¢×¨×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
<tbody id="waitlistTable"></tbody>
</table>
</div>
</div>
</div>

<!-- Reports -->
<div id="reports" class="page">
<div class="topbar">
<h1 class="page-title">×“×•×—×•×ª</h1>
<div class="topbar-actions">
<button class="btn btn-primary" onclick="exportReportToExcel()">ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ</button>
</div>
</div>
<div class="card">
<div class="card-body">
<div class="form-grid" style="margin-bottom:20px">
<div class="form-group">
<label>××ª××¨×™×š</label>
<input type="date" class="form-control" id="reportFrom">
</div>
<div class="form-group">
<label>×¢×“ ×ª××¨×™×š</label>
<input type="date" class="form-control" id="reportTo">
</div>
<div class="form-group">
<button class="btn btn-primary" onclick="generateReport()" style="margin-top:24px">ğŸ“Š ×”×¤×§ ×“×•×—</button>
</div>
</div>
<div class="tabs" style="margin-bottom:20px">
<button class="tab active" onclick="showReportTab('overview')">×¡×™×›×•× ×›×œ×œ×™</button>
<button class="tab" onclick="showReportTab('devices')">×¤×™×œ×•×— ××›×©×™×¨×™×</button>
<button class="tab" onclick="showReportTab('customers')">×¤×™×œ×•×— ×œ×§×•×—×•×ª</button>
</div>
<div id="reportResults"></div>
</div>
</div>
</div>

<!-- Expenses -->
<div id="expenses" class="page">
<div class="topbar">
<h1 class="page-title">ğŸ’¸ ×”×•×¦××•×ª ×•×”×›× ×¡×•×ª</h1>
<div class="topbar-actions">
<button class="btn btn-primary" onclick="openExpenseModal()">â• ×”×•×¡×£ ×¨×©×•××”</button>
<button class="btn btn-outline" onclick="exportExpensesToExcel()">ğŸ“Š ×™×™×¦×•×</button>
</div>
</div>
<div class="card">
<div class="card-body">
<div class="tabs" style="margin-bottom:15px">
<button class="tab active" onclick="filterExpenses('all')">×”×›×œ</button>
<button class="tab" onclick="filterExpenses('expense')">×”×•×¦××•×ª</button>
<button class="tab" onclick="filterExpenses('income')">×”×›× ×¡×•×ª</button>
</div>
<div class="form-grid" style="margin-bottom:15px">
<div class="form-group"><label>×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š</label><input type="date" class="form-control" id="expenseFilterDate" onchange="filterExpenses()"></div>
<div class="form-group"><label>×¡×™× ×•×Ÿ ×œ×¤×™ ×¤×¨×™×˜</label><input type="text" class="form-control" id="expenseFilterItem" placeholder="×—×¤×© ×¤×¨×™×˜..." oninput="filterExpenses()"></div>
</div>
<table>
<thead><tr><th>×¡×•×’</th><th>×ª×™××•×¨</th><th>×¤×¨×™×˜</th><th>×¡×›×•×</th><th>×ª××¨×™×š</th><th>××›×©×™×¨</th><th>××§×•× ×¨×›×™×©×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
<tbody id="expensesTable"></tbody>
<tfoot><tr style="font-weight:bold;background:var(--gray-100)"><td colspan="3">×¡×”"×›</td><td id="expensesTotal">â‚ª0</td><td colspan="4"></td></tr></tfoot>
</table>
</div>
</div>
</div>

<!-- Instructions -->
<div id="instructions" class="page">
<div class="topbar">
<h1 class="page-title">ğŸ“œ ×”×•×¨××•×ª ×”×’×"×—</h1>
</div>
<div class="card">
<div class="card-body">
<div class="form-group">
<label>×”×•×¨××•×ª ×”×©×™××•×© (×˜×§×¡×˜)</label>
<textarea class="form-control" id="instructionsText" rows="10" placeholder="×›×ª×•×‘ ×›××Ÿ ××ª ×”×•×¨××•×ª ×”×©×™××•×© ×‘×’×"×—..."></textarea>
</div>
<div class="form-group">
<label>×ª××•× ×ª ×”×•×¨××•×ª (URL)</label>
<input type="text" class="form-control" id="instructionsImage" placeholder="×”×›× ×¡ ×›×ª×•×‘×ª URL ×œ×ª××•× ×”">
</div>
<button class="btn btn-success" onclick="saveInstructions()">ğŸ’¾ ×©××•×¨ ×”×•×¨××•×ª</button>
<div id="instructionsPreview" style="margin-top:20px"></div>
</div>
</div>
</div>

<!-- Settings -->
<div id="settings" class="page">
<div class="topbar">
<h1 class="page-title">×”×’×“×¨×•×ª</h1>
</div>
<div class="card">
<div class="card-body">
<h3 style="margin-bottom:15px;color:var(--primary)">××™×ª×•×’ ×”×’×"×—</h3>
<div class="form-grid">
<div class="form-group"><label>×©× ×”×’×"×—</label><input type="text" class="form-control" id="gmachName" placeholder="×’×"×— ×•×•×™×–"></div>
<div class="form-group"><label>×©× ××©×¤×—×”/×›×™×ª×•×‘ ××©× ×”</label><input type="text" class="form-control" id="gmachSubtitle" placeholder="××©×¤' ×¦×“×§×”"></div>
<div class="form-group">
<label>×œ×•×’×• (×›×ª×•×‘×ª ×ª××•× ×”)</label>
<input type="text" class="form-control" id="gmachLogo" placeholder="×œ×•×’×•.jpg">
<small style="color:var(--gray-500)">×©× ×§×•×‘×¥ ××• ×›×ª×•×‘×ª URL</small>
</div>
</div>

<h3 style="margin:20px 0 15px;color:var(--primary)">×¨×§×¢ ×”×ª×•×›× ×”</h3>
<div class="form-group">
<label>×‘×—×¨ ×¨×§×¢</label>
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
<div class="bg-option" onclick="setBackground('default')" style="width:40px;height:40px;background:var(--gray-100);border-radius:8px;cursor:pointer;border:2px solid var(--gray-300)"></div>
<div class="bg-option" onclick="setBackground('#E3F2FD')" style="width:40px;height:40px;background:#E3F2FD;border-radius:8px;cursor:pointer;border:2px solid var(--gray-300)"></div>
<div class="bg-option" onclick="setBackground('#F3E5F5')" style="width:40px;height:40px;background:#F3E5F5;border-radius:8px;cursor:pointer;border:2px solid var(--gray-300)"></div>
<div class="bg-option" onclick="setBackground('#E8F5E9')" style="width:40px;height:40px;background:#E8F5E9;border-radius:8px;cursor:pointer;border:2px solid var(--gray-300)"></div>
<div class="bg-option" onclick="setBackground('#FFF3E0')" style="width:40px;height:40px;background:#FFF3E0;border-radius:8px;cursor:pointer;border:2px solid var(--gray-300)"></div>
<div class="bg-option" onclick="setBackground('#ECEFF1')" style="width:40px;height:40px;background:#ECEFF1;border-radius:8px;cursor:pointer;border:2px solid var(--gray-300)"></div>
</div>
</div>
<div class="form-group">
<label>××• ×”×¢×œ×” ×ª××•× ×ª ×¨×§×¢</label>
<input type="text" class="form-control" id="bgImage" placeholder="×›×ª×•×‘×ª URL ×œ×ª××•× ×”">
<button class="btn btn-sm btn-outline" style="margin-top:8px" onclick="applyBgImage()">×”×—×œ ×¨×§×¢ ×ª××•× ×”</button>
</div>

<h3 style="margin:20px 0 15px;color:var(--primary)">×¤×¨×˜×™ ×‘×¢×œ ×”×’×"×—</h3>
<div class="form-grid">
<div class="form-group"><label>×©× ×‘×¢×œ ×”×’×"×—</label><input type="text" class="form-control" id="ownerName"></div>
<div class="form-group"><label>×˜×œ×¤×•×Ÿ</label><input type="tel" class="form-control" id="ownerPhone"></div>
<div class="form-group"><label>×¢×™×¨</label><input type="text" class="form-control" id="ownerCity"></div>
<div class="form-group"><label>×œ×¢×™×œ×•×™ × ×©××ª</label><input type="text" class="form-control" id="ownerDedication"></div>
</div>

<h3 style="margin:20px 0 15px;color:var(--primary)">×”×’×“×¨×•×ª ×”×©×›×¨×”</h3>
<div class="form-grid">
<div class="form-group"><label>××—×™×¨ ×‘×¨×™×¨×ª ××—×“×œ (â‚ª)</label><input type="number" class="form-control" id="defaultPrice" value="10"></div>
<div class="form-group"><label>×§× ×¡ ××™×—×•×¨ ×œ×™×•× (â‚ª)</label><input type="number" class="form-control" id="lateFee" value="5"></div>
</div>

<h3 style="margin:20px 0 15px;color:var(--primary)">×©×‘×ª ×•×—×’×™×</h3>
<div class="form-group">
<label class="form-check"><input type="checkbox" id="skipShabbat" checked> ×œ× ×œ×—×™×™×‘ ×¢×œ ×™××™ ×©×‘×ª</label>
</div>
<div class="form-group">
<label class="form-check"><input type="checkbox" id="skipHolidays" checked> ×œ× ×œ×—×™×™×‘ ×¢×œ ×—×’×™×</label>
</div>

<h3 style="margin:20px 0 15px;color:var(--primary)">××‘×˜×—×”</h3>
<div class="form-group" style="max-width:300px">
<label>×¡×™×¡××ª ×›× ×™×¡×” (××•×¤×¦×™×•× ×œ×™)</label>
<input type="password" class="form-control" id="appPassword" placeholder="×”×©××¨ ×¨×™×§ ×œ×‘×™×˜×•×œ">
</div>

<div style="margin-top:25px;display:flex;gap:10px;flex-wrap:wrap">
<button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
<button class="btn btn-outline" onclick="exportData()">ğŸ“¤ ×™×™×¦× ×’×™×‘×•×™</button>
<button class="btn btn-outline" onclick="document.getElementById('importFile').click()">ğŸ“¥ ×™×™×‘× ×’×™×‘×•×™</button>
<button class="btn btn-danger" onclick="resetAllData()">ğŸ—‘ï¸ ××¤×¡ × ×ª×•× ×™×</button>
<input type="file" id="importFile" style="display:none" onchange="importData(event)" accept=".json">
</div>
</div>
</div>
</div>

<footer class="footer">
    <div>×¤×•×ª×— ×¢×œ ×™×“×™ ×—× × ××œ | <a href="tel:0527104792">052-7104792</a> | ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª Â©</div>
</footer>
</main>
</div>

<!-- Modals -->
<div id="endRentalModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>ğŸ“¥ ×¡×™×•× ×”×©×›×¨×”</h2>
<button class="modal-close" onclick="closeModal('endRentalModal')">&times;</button>
</div>
<div class="modal-body">
<div class="form-group">
<label>×‘×—×¨ ××›×©×™×¨ ×œ×”×—×–×¨×”</label>
<select class="form-control" id="endRentalSelect" onchange="showEndRentalDetails()"></select>
</div>
<div id="endRentalDetails" style="display:none"></div>
</div>
</div>
</div>

<div id="editRentalModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>âœï¸ ×¢×¨×™×›×ª ×”×©×›×¨×”</h2>
<button class="modal-close" onclick="closeModal('editRentalModal')">&times;</button>
</div>
<div class="modal-body" id="editRentalContent"></div>
</div>
</div>

<div id="deviceModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="deviceModalTitle">ğŸ“± ×”×•×¡×¤×ª ××›×©×™×¨</h2>
<button class="modal-close" onclick="closeModal('deviceModal')">&times;</button>
</div>
<div class="modal-body">
<form onsubmit="return saveDevice(event)">
<input type="hidden" id="editDeviceId">
<div class="form-grid">
<div class="form-group"><label class="required">××¡×¤×¨ ××›×©×™×¨</label><input type="text" class="form-control" id="deviceNumber" required></div>
<div class="form-group"><label>×“×’×</label><input type="text" class="form-control" id="deviceModel"></div>
<div class="form-group"><label>×¡×•×’</label><select class="form-control" id="deviceType"><option value="standard">×¨×’×™×œ</option><option value="large">××¡×š ×’×“×•×œ</option><option value="small">××¡×š ×§×˜×Ÿ</option><option value="kosher">×›×©×¨</option></select></div>
<div class="form-group"><label>××—×™×¨ ×œ×™×•× (â‚ª)</label><input type="number" class="form-control" id="devicePrice" value="10"></div>
<div class="form-group"><label>×ª××¨×™×š ×—×™×“×•×© SIM</label><input type="date" class="form-control" id="deviceSimDate"></div>
<div class="form-group"><label>×¢×œ×•×ª ×¨×›×™×©×” (â‚ª)</label><input type="number" class="form-control" id="deviceCost" value="0"></div>
</div>
<div class="form-group"><label>× ×ª×¨× ×¢"×™ / ×œ×¢×™×œ×•×™ × ×©××ª</label><input type="text" class="form-control" id="deviceDonor"></div>
<div class="form-group"><label>×”×¢×¨×•×ª</label><textarea class="form-control" id="deviceNotes" rows="2"></textarea></div>
<div class="modal-footer" style="padding:0;border:0;margin-top:20px">
<button type="submit" class="btn btn-success">ğŸ’¾ ×©××•×¨</button>
<button type="button" class="btn btn-danger" onclick="deleteDevice()" id="deleteDeviceBtn" style="display:none">ğŸ—‘ï¸ ××—×§</button>
</div>
</form>
</div>
</div>
</div>

<div id="customerModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="customerModalTitle">ğŸ‘¤ ×œ×§×•×—</h2>
<button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
</div>
<div class="modal-body">
<form onsubmit="return saveCustomer(event)">
<input type="hidden" id="editCustomerId">
<div class="form-grid">
<div class="form-group"><label class="required">×©× ××œ×</label><input type="text" class="form-control" id="custName" required></div>
<div class="form-group"><label class="required">×˜×œ×¤×•×Ÿ</label><input type="tel" class="form-control" id="custPhone" required></div>
<div class="form-group"><label>×›×ª×•×‘×ª</label><input type="text" class="form-control" id="custAddress"></div>
<div class="form-group"><label>×—×•×‘ (â‚ª)</label><input type="number" class="form-control" id="custDebt" value="0"></div>
<div class="form-group"><label>×× ×•×™ - ×™××™× ×©× ×•×ª×¨×•</label><input type="number" class="form-control" id="custSubscription" value="0"></div>
</div>
<div class="form-group"><label>×”×¢×¨×•×ª</label><textarea class="form-control" id="custNotes" rows="2"></textarea></div>
<div class="modal-footer" style="padding:0;border:0;margin-top:20px">
<button type="submit" class="btn btn-success">ğŸ’¾ ×©××•×¨</button>
<button type="button" class="btn btn-danger" onclick="deleteCustomer()" id="deleteCustomerBtn" style="display:none">ğŸ—‘ï¸ ××—×§</button>
</div>
</form>
</div>
</div>
</div>

<div id="waitlistModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>â³ ×”×•×¡×¤×” ×œ×¨×©×™××ª ×”××ª× ×”</h2>
<button class="modal-close" onclick="closeModal('waitlistModal')">&times;</button>
</div>
<div class="modal-body">
<form onsubmit="return addToWaitlist(event)">
<div class="form-grid">
<div class="form-group"><label class="required">×©×</label><input type="text" class="form-control" id="waitName" required></div>
<div class="form-group"><label class="required">×˜×œ×¤×•×Ÿ</label><input type="tel" class="form-control" id="waitPhone" required></div>
<div class="form-group"><label>×¡×•×’ ××›×©×™×¨ ××‘×•×§×©</label><select class="form-control" id="waitType"><option value="any">×›×œ ×¡×•×’</option><option value="standard">×¨×’×™×œ</option><option value="large">××¡×š ×’×“×•×œ</option><option value="kosher">×›×©×¨</option></select></div>
</div>
<div class="form-group"><label>×”×¢×¨×•×ª</label><textarea class="form-control" id="waitNotes" rows="2"></textarea></div>
<div class="modal-footer" style="padding:0;border:0;margin-top:20px">
<button type="submit" class="btn btn-success">ğŸ’¾ ×”×•×¡×£ ×œ×ª×•×¨</button>
</div>
</form>
</div>
</div>
</div>

<div id="expenseModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="expenseModalTitle">ğŸ’¸ ×”×•×¡×¤×ª ×¨×©×•××”</h2>
<button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
</div>
<div class="modal-body">
<form onsubmit="return saveExpense(event)">
<input type="hidden" id="editExpenseId">
<div class="form-grid">
<div class="form-group">
<label class="required">×¡×•×’</label>
<select class="form-control" id="expenseType" required>
<option value="expense">×”×•×¦××”</option>
<option value="income">×”×›× ×¡×”</option>
</select>
</div>
<div class="form-group"><label class="required">×ª×™××•×¨</label><input type="text" class="form-control" id="expenseDesc" required></div>
<div class="form-group"><label>×¤×¨×™×˜</label><input type="text" class="form-control" id="expenseItem" placeholder="×›×‘×œ, ××¦×ª, ×•×›×•'"></div>
<div class="form-group"><label class="required">×¡×›×•× (â‚ª)</label><input type="number" class="form-control" id="expenseAmount" required></div>
<div class="form-group"><label>×ª××¨×™×š</label><input type="date" class="form-control" id="expenseDate"></div>
<div class="form-group"><label>××›×©×™×¨ ×§×©×•×¨</label><select class="form-control" id="expenseDevice"><option value="">×œ×œ×</option></select></div>
<div class="form-group"><label>××§×•× ×¨×›×™×©×”</label><input type="text" class="form-control" id="expensePlace" placeholder="××™×¤×” × ×§× ×”?"></div>
</div>
<div class="form-group"><label>×”×¢×¨×•×ª</label><textarea class="form-control" id="expenseNotes" rows="2"></textarea></div>
<div class="modal-footer" style="padding:0;border:0;margin-top:20px">
<button type="submit" class="btn btn-success">ğŸ’¾ ×©××•×¨</button>
<button type="button" class="btn btn-danger" onclick="deleteExpense()" id="deleteExpenseBtn" style="display:none">ğŸ—‘ï¸ ××—×§</button>
</div>
</form>
</div>
</div>
</div>

<div id="customerActionsModal" class="modal">
<div class="modal-content" style="max-width:400px">
<div class="modal-header">
<h2 id="customerActionsTitle">ğŸ‘¤ ×¤×¢×•×œ×•×ª ×œ×§×•×—</h2>
<button class="modal-close" onclick="closeModal('customerActionsModal')">&times;</button>
</div>
<div class="modal-body" id="customerActionsContent"></div>
</div>
</div>

<div id="deviceNeedsModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>ğŸ”§ ×¦×™×•×“ × ×“×¨×© ×œ××›×©×™×¨</h2>
<button class="modal-close" onclick="closeModal('deviceNeedsModal')">&times;</button>
</div>
<div class="modal-body" id="deviceNeedsContent"></div>
</div>
</div>

<div id="reserveModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>ğŸ“… ×©××™×¨×ª ××›×©×™×¨</h2>
<button class="modal-close" onclick="closeModal('reserveModal')">&times;</button>
</div>
<div class="modal-body">
<form onsubmit="return saveReservation(event)">
<div class="form-grid">
<div class="form-group"><label class="required">×©× ×œ×§×•×—</label><input type="text" class="form-control" id="reserveName" required></div>
<div class="form-group"><label class="required">×˜×œ×¤×•×Ÿ</label><input type="tel" class="form-control" id="reservePhone" required></div>
<div class="form-group"><label>××›×©×™×¨</label><select class="form-control" id="reserveDevice"></select></div>
<div class="form-group"><label class="required">×ª××¨×™×š ×©××™×¨×”</label><input type="date" class="form-control" id="reserveDate" required></div>
</div>
<div class="form-group"><label>×”×¢×¨×•×ª</label><textarea class="form-control" id="reserveNotes" rows="2"></textarea></div>
<div class="modal-footer" style="padding:0;border:0;margin-top:20px">
<button type="submit" class="btn btn-success">ğŸ’¾ ×©××•×¨</button>
</div>
</form>
</div>
</div>
</div>

<script src="×œ×•×— ×©× ×” ×¢×‘×¨×™.js"></script>
<script>
// ×ª××¨×™×š ×¢×‘×¨×™ ×××™×ª×™ ×‘×××¦×¢×•×ª ×§×•×‘×¥ ×œ×•×— ×©× ×” ×¢×‘×¨×™.js
function getHebrewDate(dateStr) {
    try {
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        
        const hebrewDate = convertToHebrew(day, month, year);
        if (hebrewDate) {
            return formatHebrewDate(hebrewDate);
        }
        return '';
    } catch (e) {
        return '';
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleDateString('he-IL');
}

function getDayName(dateStr) {
    if (!dateStr) return '';
    const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
    return '×™×•× ' + days[new Date(dateStr).getDay()];
}

function formatDateTime(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('he-IL') + ' ' + date.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
}

// × ×ª×•× ×™×
let data = {
    devices: [],
    customers: [],
    rentals: [],
    waitlist: [],
    expenses: [],
    instructions: { text: '', image: '' },
    settings: {
        defaultPrice: 10,
        lateFee: 5,
        skipShabbat: true,
        skipHolidays: true,
        password: '',
        gmachName: '×’×"×— ×•×•×™×–',
        gmachSubtitle: '××©×¤\' ×¦×“×§×”',
        gmachLogo: '×œ×•×’×•.jpg',
        bgColor: 'default'
    }
};

let currentReportTab = 'overview';

let currentCalendarDate = new Date();

// ×˜×¢×™× ×” ×•×©××™×¨×”
function loadData() {
    const saved = localStorage.getItem('gmachWaze');
    if (saved) {
        const loaded = JSON.parse(saved);
        // ×©××™×¨×” ×©×œ ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™×
        data = {
            devices: loaded.devices || [],
            customers: loaded.customers || [],
            rentals: loaded.rentals || [],
            waitlist: loaded.waitlist || [],
            expenses: loaded.expenses || [],
            instructions: loaded.instructions || { text: '', image: '' },
            settings: {
                ...data.settings, // ×©××™×¨×” ×¢×œ ×‘×¨×™×¨×•×ª ××—×“×œ
                ...loaded.settings // ×¢×“×›×•×Ÿ ××”× ×ª×•× ×™× ×©× ×©××¨×•
            }
        };
    }
    
    // ×‘×“×™×§×ª ×¡×™×¡××”
    if (data.settings && data.settings.password && data.settings.password.trim() !== '') {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.querySelector('.app').style.display = 'none';
    } else {
        document.getElementById('loginScreen').classList.add('hidden');
        document.querySelector('.app').style.display = 'flex';
    }
    
    // ×”×—×œ ×¨×§×¢ ×©××•×¨
    if (data.settings.bgColor && data.settings.bgColor !== 'default') {
        document.body.style.background = data.settings.bgColor;
    }
    if (data.settings.bgImage) {
        document.body.style.backgroundImage = `url(${data.settings.bgImage})`;
        document.body.style.backgroundSize = 'cover';
    }
    
    // ×¢×“×›×•×Ÿ ×©× ×•×¡××‘×˜×™×™×˜×œ
    updateBranding();
    
    updateAll();
    loadSettings();
    loadInstructions();
}

function updateBranding() {
    const name = data.settings.gmachName || '×’×"×— ×•×•×™×–';
    const subtitle = data.settings.gmachSubtitle || '××©×¤\' ×¦×“×§×”';
    const logo = data.settings.gmachLogo || '×œ×•×’×•.jpg';
    
    document.querySelectorAll('.sidebar-header h1').forEach(el => el.textContent = name);
    document.querySelectorAll('.sidebar-header span').forEach(el => el.textContent = subtitle);
    document.querySelectorAll('.sidebar-header img').forEach(el => el.src = logo);
    document.querySelectorAll('.login-box img').forEach(el => el.src = logo);
    document.querySelectorAll('.login-box h2').forEach(el => el.textContent = name + ' - ' + subtitle);
    document.title = name + ' - ' + subtitle;
}

function checkPassword() {
    const input = document.getElementById('loginPassword').value;
    const saved = localStorage.getItem('gmachWaze');
    let savedData = {settings: {password: ''}};
    if (saved) savedData = JSON.parse(saved);
    
    if (!savedData.settings.password || savedData.settings.password.trim() === '' || input === savedData.settings.password) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.querySelector('.app').style.display = 'flex';
        document.getElementById('loginPassword').value = '';
    } else {
        alert('âŒ ×¡×™×¡××” ×©×’×•×™×”!');
        document.getElementById('loginPassword').value = '';
    }
}

function saveData() {
    localStorage.setItem('gmachWaze', JSON.stringify(data));
}

// × ×™×•×•×˜
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    event?.target?.classList?.add('active');
    
    if (pageId === 'calendar') renderCalendar();
    if (pageId === 'newRental') {
        updateDeviceSelects();
        // ×‘×¨×™×¨×ª ××—×“×œ - ×›×‘×œ ×•××¦×ª
        document.getElementById('accCable').checked = true;
        document.getElementById('accCarCharger').checked = true;
        document.getElementById('accMagnet').checked = false;
        document.getElementById('accArm').checked = false;
        document.getElementById('accOther').checked = false;
        document.getElementById('otherAccessoryGroup').style.display = 'none';
    }
    updateAll();
}

// ×¢×“×›×•×Ÿ ×›×œ×œ×™
function updateAll() {
    updateStats();
    updateActiveRentals();
    updateRentalsGrid();
    updateDevicesTable();
    updateCustomersTable();
    updateWaitlistTable();
    updateDeviceSelects();
    updateExpensesTable();
    checkAlerts();
}

// ×‘×“×™×§×ª ×”×ª×¨××•×ª
function checkAlerts() {
    // ×”×ª×¨××•×ª SIM
    data.devices.forEach(d => {
        if (d.simDate) {
            const daysLeft = Math.ceil((new Date(d.simDate) - new Date()) / (1000*60*60*24));
            if (daysLeft <= 7 && daysLeft > 0) {
                console.log(`×”×ª×¨××”: ××›×©×™×¨ ${d.number} - SIM ××¡×ª×™×™× ×‘×¢×•×“ ${daysLeft} ×™××™×`);
            }
        }
    });
    
    // ×”×ª×¨××” ×¢×œ ×¨×©×™××ª ×”××ª× ×”
    if (data.waitlist.length > 0) {
        const available = data.devices.filter(d => d.status === 'available');
        data.waitlist.forEach(w => {
            if (available.some(d => w.type === 'any' || d.type === w.type)) {
                console.log(`×”×ª×¨××”: ×™×© ××›×©×™×¨ ×¤× ×•×™ ×¢×‘×•×¨ ${w.name} ××¨×©×™××ª ×”×”××ª× ×”!`);
            }
        });
    }
}

// ×¡×˜×˜×™×¡×˜×™×§×•×ª
function updateStats() {
    const available = data.devices.filter(d => d.status === 'available').length;
    const rented = data.rentals.filter(r => !r.returnDate).length;
    const overdue = data.rentals.filter(r => !r.returnDate && new Date(r.expectedReturn) < new Date()).length;
    const totalDebt = data.customers.reduce((sum, c) => sum + (c.debt || 0), 0);
    
    document.getElementById('statsContainer').innerHTML = `
        <div class="stat-card" onclick="filterDevices('available');showPage('devices')">
            <div class="stat-icon blue">ğŸ“±</div>
            <div class="stat-info"><h3>${available}</h3><p>××›×©×™×¨×™× ×–××™× ×™×</p></div>
        </div>
        <div class="stat-card" onclick="filterRentals('active');showPage('rentals')">
            <div class="stat-icon green">ğŸ“‹</div>
            <div class="stat-info"><h3>${rented}</h3><p>××•×©×›×¨×™× ×›×¢×ª</p></div>
        </div>
        <div class="stat-card" onclick="filterRentals('overdue');showPage('rentals')">
            <div class="stat-icon ${overdue > 0 ? 'red' : 'green'}">â°</div>
            <div class="stat-info"><h3>${overdue}</h3><p>×‘××™×—×•×¨</p></div>
        </div>
        <div class="stat-card" onclick="filterCustomers('debt');showPage('customers')">
            <div class="stat-icon ${totalDebt > 0 ? 'orange' : 'green'}">ğŸ’°</div>
            <div class="stat-info"><h3>â‚ª${totalDebt}</h3><p>×—×•×‘×•×ª ×¤×ª×•×—×™×</p></div>
        </div>
    `;
}

// ×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª
function updateActiveRentals() {
    const active = data.rentals.filter(r => !r.returnDate);
    const container = document.getElementById('activeRentalsGrid');
    
    if (active.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>××™×Ÿ ×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª</p></div>';
        return;
    }
    
    let html = '';
    for (const r of active) {
        const customer = data.customers.find(c => c.id === r.customerId);
        const isOverdue = new Date(r.expectedReturn) < new Date();
        const hebrewStart = getHebrewDate(r.startDate);
        const hebrewEnd = getHebrewDate(r.expectedReturn);
        
        html += `
        <div class="rental-card ${isOverdue ? 'overdue' : ''}">
            <div class="rental-card-header">
                <div>
                    <div class="rental-customer">${customer?.name || '×œ×§×•×—'}</div>
                    <div class="rental-device">××›×©×™×¨ ${r.deviceNumber}</div>
                </div>
                <span class="status-badge ${isOverdue ? 'status-overdue' : 'status-rented'}">${isOverdue ? '×‘××™×—×•×¨' : '×¤×¢×™×œ'}</span>
            </div>
            <div class="rental-dates">
                ğŸ“… ${formatDate(r.startDate)} - ${formatDate(r.expectedReturn)}
                <div class="rental-hebrew">${hebrewStart} - ${hebrewEnd}</div>
            </div>
            <div class="rental-actions">
                <button class="btn btn-sm btn-outline" onclick="openEditRental('${r.id}')">âœï¸ ×¢×¨×•×š</button>
                <button class="btn btn-sm btn-success" onclick="quickEndRental('${r.id}')">ğŸ“¥ ×”×—×–×¨</button>
            </div>
        </div>`;
    }
    container.innerHTML = html;
}

// ×‘×—×™×¨×•×ª ××›×©×™×¨×™×
function updateDeviceSelects() {
    const available = data.devices.filter(d => d.status === 'available');
    const select = document.getElementById('deviceSelect');
    if (select) {
        select.innerHTML = '<option value="">×‘×—×¨ ××›×©×™×¨...</option>' + 
            available.map(d => `<option value="${d.id}">${d.number} - ${d.model || d.type || '×¨×’×™×œ'} (â‚ª${d.price || 10})</option>`).join('');
    }
    
    const rented = data.rentals.filter(r => !r.returnDate);
    const endSelect = document.getElementById('endRentalSelect');
    if (endSelect) {
        endSelect.innerHTML = '<option value="">×‘×—×¨ ××›×©×™×¨...</option>' + 
            rented.map(r => {
                const customer = data.customers.find(c => c.id === r.customerId);
                return `<option value="${r.id}">××›×©×™×¨ ${r.deviceNumber} - ${customer?.name || '×œ×§×•×—'}</option>`;
            }).join('');
    }
}

// ×—×™×¤×•×© ×œ×§×•×—×•×ª
function searchCustomers(query) {
    const container = document.getElementById('customerSuggestions');
    if (!query || query.length < 2) {
        container.style.display = 'none';
        return;
    }
    
    const matches = data.customers.filter(c => c.name.includes(query) || c.phone.includes(query));
    if (matches.length > 0) {
        container.innerHTML = matches.map(c => 
            `<div style="padding:10px;cursor:pointer;border-bottom:1px solid var(--gray-200)" onclick="selectCustomer('${c.id}')">${c.name} - ${c.phone}</div>`
        ).join('');
        container.style.display = 'block';
    } else {
        container.innerHTML = `<div style="padding:10px;cursor:pointer" onclick="openCustomerModal()">â• ×”×•×¡×£ ×œ×§×•×— ×—×“×©</div>`;
        container.style.display = 'block';
    }
}

function selectCustomer(id) {
    const customer = data.customers.find(c => c.id === id);
    if (customer) {
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerPhone').value = customer.phone;
        document.getElementById('customerSuggestions').style.display = 'none';
    }
}

// ×¢×“×›×•×Ÿ ×ª××¨×™×š ×”×—×–×¨×”
function updateReturnDate() {
    const duration = document.getElementById('rentalDuration').value;
    const hoursGroup = document.getElementById('hoursGroup');
    const customGroup = document.getElementById('customDateGroup');
    
    hoursGroup.style.display = 'none';
    customGroup.style.display = 'none';
    
    if (duration === 'custom') {
        customGroup.style.display = 'block';
    } else if (duration === 'hours' || duration === 'evening' || duration === 'morning') {
        hoursGroup.style.display = 'block';
        // ×”×’×“×¨ ×‘×¨×™×¨×•×ª ××—×“×œ
        if (duration === 'evening') {
            document.getElementById('returnTime').value = '19:00';
        } else if (duration === 'morning') {
            document.getElementById('returnTime').value = '09:00';
        }
    }
}

// ×—×™×©×•×‘ ×™××™ ×—×™×•×‘ (×œ×œ× ×©×‘×ª×•×ª/×—×’×™×)
function calculateChargeDays(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    let days = 0;
    const current = new Date(start);
    
    while (current <= end) {
        const dayOfWeek = current.getDay();
        const isShabbat = dayOfWeek === 6; // ×©×‘×ª
        
        if (data.settings.skipShabbat && isShabbat) {
            // ×œ× ××—×™×™×‘×™× ×¢×œ ×©×‘×ª
        } else {
            days++;
        }
        current.setDate(current.getDate() + 1);
    }
    
    return Math.max(1, days);
}

// ×™×¦×™×¨×ª ×”×©×›×¨×”
function createRental(e) {
    e.preventDefault();
    
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const deviceId = document.getElementById('deviceSelect').value;
    
    if (!name || !phone || !deviceId) {
        alert('× × ×œ××œ× ×©×, ×˜×œ×¤×•×Ÿ ×•×œ×‘×—×•×¨ ××›×©×™×¨');
        return false;
    }
    
    // ×œ×§×•×—
    let customer = data.customers.find(c => c.phone === phone);
    if (!customer) {
        customer = { id: Date.now().toString(), name, phone, rentals: 0, debt: 0, subscription: 0 };
        data.customers.push(customer);
    }
    
    // ×ª××¨×™×›×™× ×•×©×¢×•×ª
    const startDate = new Date().toISOString().split('T')[0];
    const startTime = new Date().toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
    let expectedReturn;
    let expectedTime = '';
    const duration = document.getElementById('rentalDuration').value;
    
    if (duration === 'custom') {
        expectedReturn = document.getElementById('customReturnDate').value;
    } else if (duration === 'hours' || duration === 'evening') {
        expectedReturn = startDate; // ××•×ª×• ×™×•×
        expectedTime = document.getElementById('returnTime').value;
    } else if (duration === 'morning') {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        expectedReturn = tomorrow.toISOString().split('T')[0];
        expectedTime = document.getElementById('returnTime').value;
    } else {
        const returnDate = new Date();
        returnDate.setDate(returnDate.getDate() + parseInt(duration));
        expectedReturn = returnDate.toISOString().split('T')[0];
    }
    
    // ××›×©×™×¨
    const device = data.devices.find(d => d.id === deviceId);
    device.status = 'rented';
    
    // ××—×™×¨
    let price = parseFloat(document.getElementById('rentalPrice').value) || device.price || 10;
    
    // ×‘×“×™×§×ª ×× ×•×™
    if (customer.subscription > 0) {
        const days = parseInt(duration) || 1;
        if (customer.subscription >= days) {
            customer.subscription -= days;
            price = 0; // ×—×™× × ××”×× ×•×™
        }
    }
    
    // ×¦×™×•×“ × ×œ×•×•×”
    const accessories = {
        cable: document.getElementById('accCable')?.checked,
        carCharger: document.getElementById('accCarCharger')?.checked,
        magnet: document.getElementById('accMagnet')?.checked,
        arm: document.getElementById('accArm')?.checked,
        other: document.getElementById('accOther')?.checked ? document.getElementById('accOtherText')?.value : ''
    };
    
    // ×”×©×›×¨×”
    const rental = {
        id: Date.now().toString(),
        customerId: customer.id,
        deviceId,
        deviceNumber: device.number,
        startDate,
        startTime,
        expectedReturn,
        expectedTime,
        returnDate: null,
        price,
        accessories,
        notes: document.getElementById('rentalNotes').value
    };
    
    data.rentals.push(rental);
    customer.rentals = (customer.rentals || 0) + 1;
    
    saveData();
    updateAll();
    clearRentalForm();
    alert('âœ… ×”×”×©×›×¨×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
    showPage('dashboard');
    return false;
}

function toggleOtherAccessory() {
    const checked = document.getElementById('accOther').checked;
    document.getElementById('otherAccessoryGroup').style.display = checked ? 'block' : 'none';
    if (!checked) {
        document.getElementById('accOtherText').value = '';
    }
}

function toggleComplaintOther() {
    const checked = document.getElementById('complaintOther').checked;
    document.getElementById('complaintOtherText').style.display = checked ? 'block' : 'none';
    if (!checked) {
        document.getElementById('complaintOtherText').value = '';
    }
}

function clearRentalForm() {
    document.getElementById('rentalForm').reset();
    document.getElementById('customDateGroup').style.display = 'none';
    document.getElementById('otherAccessoryGroup').style.display = 'none';
    // ×‘×¨×™×¨×ª ××—×“×œ
    document.getElementById('accCable').checked = true;
    document.getElementById('accCarCharger').checked = true;
}

// ×¡×™×•× ×”×©×›×¨×”
function openEndRentalModal() {
    updateDeviceSelects();
    document.getElementById('endRentalDetails').style.display = 'none';
    openModal('endRentalModal');
}

function showEndRentalDetails() {
    const rentalId = document.getElementById('endRentalSelect').value;
    if (!rentalId) {
        document.getElementById('endRentalDetails').style.display = 'none';
        return;
    }
    
    const rental = data.rentals.find(r => r.id === rentalId);
    const customer = data.customers.find(c => c.id === rental.customerId);
    
    // ×—×™×©×•×‘ ×¡×›×•×
    const days = calculateChargeDays(rental.startDate, new Date().toISOString().split('T')[0]);
    let amount = days * rental.price;
    
    // ×§× ×¡ ××™×—×•×¨
    if (new Date() > new Date(rental.expectedReturn)) {
        const lateDays = Math.ceil((new Date() - new Date(rental.expectedReturn)) / (1000*60*60*24));
        amount += lateDays * (data.settings.lateFee || 5);
    }
    
    const hebrewStart = getHebrewDate(rental.startDate);
    const hebrewExpected = getHebrewDate(rental.expectedReturn);
    
    document.getElementById('endRentalDetails').innerHTML = `
        <div style="background:var(--gray-50);padding:15px;border-radius:8px;margin:15px 0">
            <p><strong>×œ×§×•×—:</strong> ${customer?.name}</p>
            <p><strong>××›×©×™×¨:</strong> ${rental.deviceNumber}</p>
            <p><strong>×”×ª×—×œ×”:</strong> ${formatDate(rental.startDate)} (${hebrewStart})</p>
            <p><strong>×¦×¤×™ ×”×—×–×¨×”:</strong> ${formatDate(rental.expectedReturn)} (${hebrewExpected})</p>
            ${rental.hasInsurance ? '<p><strong>×‘×™×˜×•×— ×©×‘×¨:</strong> âœ… ×›×œ×•×œ</p>' : ''}
        </div>
        <div class="form-group">
            <label>×¡×›×•× ×œ×ª×©×œ×•× (â‚ª)</label>
            <input type="number" class="form-control" id="endRentalAmount" value="${Math.round(amount)}">
        </div>
        <div class="form-group">
            <label class="form-check"><input type="checkbox" id="endRentalPaid"> ×©×•×œ×</label>
        </div>
        <div class="form-group">
            <label>×“×™×•×•×— ×¢×œ ×‘×¢×™×•×ª</label>
            <div class="checkbox-grid">
                <label class="form-check"><input type="checkbox" id="complaintBattery"> ×¡×•×œ×œ×” × ×’××¨×ª ××”×¨</label>
                <label class="form-check"><input type="checkbox" id="complaintCable"> ×›×‘×œ ×ª×§×•×œ</label>
                <label class="form-check"><input type="checkbox" id="complaintCharger"> ×œ×œ× ××¦×ª</label>
                <label class="form-check"><input type="checkbox" id="complaintNoSignal"> ××™×Ÿ ×¨×©×ª</label>
                <label class="form-check"><input type="checkbox" id="complaintNoGPS"> ×œ× ×§×•×œ×˜ GPS</label>
                <label class="form-check"><input type="checkbox" id="complaintOther" onchange="toggleComplaintOther()"> ××—×¨</label>
            </div>
            <input type="text" class="form-control" id="complaintOtherText" placeholder="×¤×¨×˜ ×‘×¢×™×” ××—×¨×ª..." style="margin-top:8px;display:none">
        </div>
        <div class="form-group">
            <label>×”×¢×¨×•×ª ×”×—×–×¨×”</label>
            <textarea class="form-control" id="endRentalNotes" rows="2"></textarea>
        </div>
        <div style="display:flex;gap:10px">
            <button class="btn btn-success" onclick="processEndRental('${rentalId}')">âœ… ××©×¨ ×”×—×–×¨×”</button>
            <button class="btn btn-danger" onclick="cancelRental('${rentalId}')">âŒ ×‘×˜×œ ×”×©×›×¨×”</button>
        </div>
    `;
    document.getElementById('endRentalDetails').style.display = 'block';
}

function processEndRental(rentalId) {
    const rental = data.rentals.find(r => r.id === rentalId);
    const customer = data.customers.find(c => c.id === rental.customerId);
    const device = data.devices.find(d => d.id === rental.deviceId);
    
    rental.returnDate = new Date().toISOString().split('T')[0];
    rental.returnTime = new Date().toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
    rental.amount = parseFloat(document.getElementById('endRentalAmount').value);
    rental.paid = document.getElementById('endRentalPaid').checked;
    rental.returnNotes = document.getElementById('endRentalNotes').value;
    
    // ××™×¡×•×£ ×ª×œ×•× ×•×ª
    rental.complaints = {
        battery: document.getElementById('complaintBattery')?.checked,
        cable: document.getElementById('complaintCable')?.checked,
        charger: document.getElementById('complaintCharger')?.checked,
        noSignal: document.getElementById('complaintNoSignal')?.checked,
        noGPS: document.getElementById('complaintNoGPS')?.checked,
        other: document.getElementById('complaintOther')?.checked ? document.getElementById('complaintOtherText')?.value : ''
    };
    
    device.status = 'available';
    device.revenue = (device.revenue || 0) + (rental.paid ? rental.amount : 0);
    
    // ×¢×“×›×•×Ÿ ×‘×¨×™××•×ª ×¡×•×œ×œ×”
    if (rental.complaints.battery || rental.returnNotes?.includes('×¡×•×œ×œ×”')) {
        device.batteryComplaints = (device.batteryComplaints || 0) + 1;
        if (device.batteryComplaints >= 3) {
            device.status = 'repair';
            alert('âš ï¸ ×”××›×©×™×¨ ×”×•×¢×‘×¨ ×œ×ª×™×§×•×Ÿ - 3 ×ª×œ×•× ×•×ª ×¡×•×œ×œ×”');
        }
    }
    
    // ×¢×“×›×•×Ÿ ×ª×œ×•× ×•×ª ×›×œ×œ×™×•×ª ×‘××›×©×™×¨
    if (rental.complaints.cable) device.cableComplaints = (device.cableComplaints || 0) + 1;
    if (rental.complaints.charger) device.chargerComplaints = (device.chargerComplaints || 0) + 1;
    if (rental.complaints.noSignal) device.signalComplaints = (device.signalComplaints || 0) + 1;
    if (rental.complaints.noGPS) device.gpsComplaints = (device.gpsComplaints || 0) + 1;
    
    if (!rental.paid) {
        customer.debt = (customer.debt || 0) + rental.amount;
    }
    
    saveData();
    updateAll();
    closeModal('endRentalModal');
    alert('âœ… ×”×”×—×–×¨×” × ×¨×©××”!');
}

function cancelRental(rentalId) {
    if (!confirm('×œ×‘×˜×œ ××ª ×”×”×©×›×¨×”?')) return;
    
    const rental = data.rentals.find(r => r.id === rentalId);
    const device = data.devices.find(d => d.id === rental.deviceId);
    
    rental.returnDate = new Date().toISOString().split('T')[0];
    rental.cancelled = true;
    rental.amount = 0;
    rental.paid = true;
    
    device.status = 'available';
    
    saveData();
    updateAll();
    closeModal('endRentalModal');
}

function quickEndRental(rentalId) {
    document.getElementById('endRentalSelect').value = rentalId;
    showEndRentalDetails();
    openModal('endRentalModal');
}

// ×¢×¨×™×›×ª ×”×©×›×¨×”
async function openEditRental(rentalId) {
    const rental = data.rentals.find(r => r.id === rentalId);
    const customer = data.customers.find(c => c.id === rental.customerId);
    const hebrewStart = getHebrewDate(rental.startDate);
    const hebrewExpected = getHebrewDate(rental.expectedReturn);
    const dayName = getDayName(rental.expectedReturn);
    
    document.getElementById('editRentalContent').innerHTML = `
        <div style="background:var(--gray-50);padding:15px;border-radius:8px;margin-bottom:15px">
            <p><strong>×œ×§×•×—:</strong> ${customer?.name}</p>
            <p><strong>××›×©×™×¨:</strong> ${rental.deviceNumber}</p>
            <p><strong>×”×ª×—×œ×”:</strong> ${formatDate(rental.startDate)} - ${getDayName(rental.startDate)} (${hebrewStart})</p>
            <p><strong>×©×¢×ª ×™×¦×™××”:</strong> ${rental.startTime || '×œ× ×¦×•×™×Ÿ'}</p>
        </div>
        <div class="form-group">
            <label>×ª××¨×™×š ×”×—×–×¨×” (${dayName})</label>
            <input type="date" class="form-control" id="editExpectedReturn" value="${rental.expectedReturn}" onchange="updateReturnDayName()">
            <small id="returnDayName" style="color:var(--gray-500)">${hebrewExpected}</small>
        </div>
        <div class="form-group">
            <label>×©×¢×ª ×”×—×–×¨×” ××©×•×¢×¨×ª</label>
            <input type="time" class="form-control" id="editReturnTime" value="${rental.expectedTime || ''}">
        </div>
        <div class="form-group">
            <label>×”×•×¡×£ ×™××™×</label>
            <div style="display:flex;gap:8px">
                <button type="button" class="btn btn-sm btn-outline" onclick="addDaysToRental(1)">+1</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="addDaysToRental(2)">+2</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="addDaysToRental(3)">+3</button>
                <button type="button" class="btn btn-sm btn-outline" onclick="addDaysToRental(7)">+×©×‘×•×¢</button>
            </div>
        </div>
        <div class="form-group">
            <label>××—×™×¨ ×œ×™×•× (â‚ª)</label>
            <input type="number" class="form-control" id="editRentalPrice" value="${rental.price}">
        </div>
        <div class="form-group">
            <label>×”×¢×¨×•×ª</label>
            <textarea class="form-control" id="editRentalNotes" rows="2">${rental.notes || ''}</textarea>
        </div>
        <button class="btn btn-success" onclick="saveEditRental('${rentalId}')">ğŸ’¾ ×©××•×¨</button>
    `;
    openModal('editRentalModal');
}

function updateReturnDayName() {
    const date = document.getElementById('editExpectedReturn').value;
    const hebrew = getHebrewDate(date);
    const dayName = getDayName(date);
    document.getElementById('returnDayName').textContent = dayName + ' - ' + hebrew;
}

function addDaysToRental(days) {
    const input = document.getElementById('editExpectedReturn');
    const current = new Date(input.value);
    current.setDate(current.getDate() + days);
    input.value = current.toISOString().split('T')[0];
}

function saveEditRental(rentalId) {
    const rental = data.rentals.find(r => r.id === rentalId);
    rental.expectedReturn = document.getElementById('editExpectedReturn').value;
    rental.expectedTime = document.getElementById('editReturnTime')?.value || '';
    rental.price = parseFloat(document.getElementById('editRentalPrice').value);
    rental.notes = document.getElementById('editRentalNotes')?.value || '';
    saveData();
    updateAll();
    closeModal('editRentalModal');
}

// ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×©×›×¨×•×ª
async function updateRentalsGrid(filter = 'active') {
    let filtered = data.rentals;
    switch(filter) {
        case 'active': filtered = data.rentals.filter(r => !r.returnDate); break;
        case 'overdue': filtered = data.rentals.filter(r => !r.returnDate && new Date(r.expectedReturn) < new Date()); break;
        case 'returned': filtered = data.rentals.filter(r => r.returnDate); break;
    }
    
    const container = document.getElementById('rentalsGrid');
    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>××™×Ÿ ×”×©×›×¨×•×ª</p></div>';
        return;
    }
    
    let html = '';
    for (const r of filtered) {
        const customer = data.customers.find(c => c.id === r.customerId);
        const isOverdue = !r.returnDate && new Date(r.expectedReturn) < new Date();
        
        html += `
        <div class="rental-card ${isOverdue ? 'overdue' : ''}">
            <div class="rental-card-header">
                <div>
                    <div class="rental-customer">${customer?.name || '×œ×§×•×—'}</div>
                    <div class="rental-device">××›×©×™×¨ ${r.deviceNumber}</div>
                </div>
                <span class="status-badge ${r.returnDate ? 'status-available' : (isOverdue ? 'status-overdue' : 'status-rented')}">
                    ${r.cancelled ? '×‘×•×˜×œ' : (r.returnDate ? '×”×•×—×–×¨' : (isOverdue ? '×‘××™×—×•×¨' : '×¤×¢×™×œ'))}
                </span>
            </div>
            <div class="rental-dates">ğŸ“… ${formatDate(r.startDate)} - ${formatDate(r.expectedReturn)}</div>
            <div style="font-size:13px;color:var(--gray-600)">ğŸ’° â‚ª${r.amount || r.price} ${r.paid ? 'âœ…' : 'âŒ'}</div>
            ${!r.returnDate ? `<div class="rental-actions">
                <button class="btn btn-sm btn-outline" onclick="openEditRental('${r.id}')">âœï¸</button>
                <button class="btn btn-sm btn-success" onclick="quickEndRental('${r.id}')">ğŸ“¥</button>
            </div>` : ''}
        </div>`;
    }
    container.innerHTML = html;
}

function filterRentals(filter) {
    document.querySelectorAll('#rentals .tab').forEach(t => t.classList.remove('active'));
    event?.target?.classList?.add('active');
    updateRentalsGrid(filter);
}

// ×œ×•×— ×©× ×”
function renderCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    document.getElementById('currentMonth').textContent = new Date(year, month).toLocaleDateString('he-IL', {month: 'long', year: 'numeric'});
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    
    const days = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
    let html = days.map(d => `<div class="calendar-header">${d}</div>`).join('');
    
    // ×¨×™×§×™× ×œ×¤× ×™
    for (let i = 0; i < startDay; i++) {
        html += '<div class="calendar-day"></div>';
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    // ×™××™ ×”×—×•×“×©
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const isToday = dateStr === today;
        const isPast = dateStr < today;
        
        // ×”××¨×” ×œ×¢×‘×¨×™
        const hebrewDate = convertToHebrew(day, month + 1, year);
        const hebrewDay = hebrewDate ? hebrewDate.day : day;
        const hebrewMonth = hebrewDate ? hebrewDate.month : '';
        
        // ××¦× ×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª ×œ×™×•× ×”×–×”
        const dayRentals = data.rentals.filter(r => {
            if (r.returnDate) return false;
            return r.startDate <= dateStr && r.expectedReturn >= dateStr;
        });
        
        // ××¦× ×”×©×›×¨×•×ª ×©×”×¡×ª×™×™××• (×œ×¦×‘×¢ ×—×œ×©)
        const pastRentals = data.rentals.filter(r => {
            if (!r.returnDate) return false;
            return r.startDate <= dateStr && r.expectedReturn >= dateStr;
        });
        
        // ×™×¦×™×¨×ª ×ª×™××•×¨ ×œhover
        let tooltip = '';
        if (dayRentals.length > 0) {
            dayRentals.forEach(r => {
                const customer = data.customers.find(c => c.id === r.customerId);
                tooltip += `${r.deviceNumber}: ${customer?.name || '×œ×§×•×—'} (×¢×“ ${formatDate(r.expectedReturn)})\\n`;
            });
        }
        
        html += `<div class="calendar-day ${isToday ? 'today' : ''}" 
            onclick="openRentalForDate('${dateStr}')"
            onmouseenter="showCalendarTooltip(event, '${tooltip.replace(/'/g, "\\'")}')"
            onmouseleave="hideCalendarTooltip()">
            <div class="calendar-day-num">${day}</div>
            <div style="font-size:11px;color:var(--gray-500);margin-top:2px">${hebrewDay} ${hebrewMonth}</div>
            ${pastRentals.slice(0,1).map(r => `<div class="calendar-event past">${r.deviceNumber}</div>`).join('')}
            ${dayRentals.slice(0,2).map(r => `<div class="calendar-event">${r.deviceNumber}</div>`).join('')}
            ${dayRentals.length > 2 ? `<div style="font-size:10px;color:var(--gray-500)">+${dayRentals.length-2} ×¢×•×“</div>` : ''}
        </div>`;
    }
    
    document.getElementById('calendarGrid').innerHTML = html;
}

function showCalendarTooltip(event, text) {
    if (!text || text.trim() === '') return;
    
    let tooltip = document.getElementById('calendarTooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'calendarTooltip';
        tooltip.className = 'calendar-tooltip';
        document.body.appendChild(tooltip);
    }
    
    tooltip.innerHTML = text.replace(/\\n/g, '<br>');
    tooltip.style.display = 'block';
    tooltip.style.left = (event.pageX + 10) + 'px';
    tooltip.style.top = (event.pageY + 10) + 'px';
}

function hideCalendarTooltip() {
    const tooltip = document.getElementById('calendarTooltip');
    if (tooltip) tooltip.style.display = 'none';
}

function openRentalForDate(dateStr) {
    // ×‘×“×™×§×” ×× ×™×© ××›×©×™×¨×™× ×–××™× ×™×
    const available = data.devices.filter(d => d.status === 'available');
    if (available.length === 0) {
        alert('××™×Ÿ ××›×©×™×¨×™× ×–××™× ×™× ×›×¨×’×¢');
        return;
    }
    
    showPage('newRental');
    setTimeout(() => {
        document.getElementById('rentalDuration').value = 'custom';
        document.getElementById('customDateGroup').style.display = 'block';
        document.getElementById('customReturnDate').value = dateStr;
    }, 100);
}

function changeMonth(delta) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
    renderCalendar();
}

// ××›×©×™×¨×™×
function updateDevicesTable(filter = 'all') {
    let filtered = data.devices;
    if (filter !== 'all') filtered = data.devices.filter(d => d.status === filter);
    
    const tbody = document.getElementById('devicesTable');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--gray-500)">××™×Ÿ ××›×©×™×¨×™×</td></tr>';
        return;
    }
    
    tbody.innerHTML = filtered.map(d => {
        const batteryStatus = d.batteryComplaints >= 3 ? 'ğŸ”´' : (d.batteryComplaints >= 1 ? 'ğŸŸ¡' : 'ğŸŸ¢');
        const simDays = d.simDate ? Math.ceil((new Date(d.simDate) - new Date()) / (1000*60*60*24)) : null;
        const simStatus = simDays === null ? '-' : (simDays <= 7 ? `ğŸ”´ ${simDays}d` : `ğŸŸ¢ ${simDays}d`);
        const roiMet = d.revenue >= (d.cost || 0);
        const needsCount = (d.needs || []).length;
        
        return `<tr>
            <td><strong>${d.number}</strong></td>
            <td>${d.model || '-'}</td>
            <td>${getTypeName(d.type)}</td>
            <td>â‚ª${d.price || 10}</td>
            <td><span class="status-badge status-${d.status}">${getStatusName(d.status)}</span></td>
            <td>${batteryStatus} ${d.batteryComplaints || 0}</td>
            <td>${simStatus}</td>
            <td style="color:${roiMet ? 'var(--success)' : ''}">â‚ª${d.revenue || 0}</td>
            <td>
                <button class="btn btn-sm btn-outline" onclick="editDevice('${d.id}')">âœï¸</button>
                <button class="btn btn-sm btn-outline" onclick="openDeviceNeeds('${d.id}')" title="×¦×™×•×“ × ×“×¨×©">${needsCount > 0 ? 'ğŸ”§' + needsCount : 'ğŸ”§'}</button>
            </td>
        </tr>`;
    }).join('');
}

function openDeviceNeeds(deviceId) {
    const device = data.devices.find(d => d.id === deviceId);
    if (!device) return;
    
    document.getElementById('deviceNeedsContent').innerHTML = `
        <div style="margin-bottom:15px"><strong>××›×©×™×¨:</strong> ${device.number}</div>
        <div class="form-group">
            <label>×¦×™×•×“ × ×“×¨×© ×œ××›×©×™×¨ ×–×”</label>
            <div class="checkbox-grid">
                <label class="form-check"><input type="checkbox" id="needCable" ${device.needs?.includes('cable') ? 'checked' : ''}> ×›×‘×œ ×˜×¢×™× ×”</label>
                <label class="form-check"><input type="checkbox" id="needCharger" ${device.needs?.includes('charger') ? 'checked' : ''}> ××¦×ª ×œ×¨×›×‘</label>
                <label class="form-check"><input type="checkbox" id="needMagnet" ${device.needs?.includes('magnet') ? 'checked' : ''}> ××’× ×˜</label>
                <label class="form-check"><input type="checkbox" id="needArm" ${device.needs?.includes('arm') ? 'checked' : ''}> ×–×¨×•×¢ ×œ×¨×›×‘</label>
                <label class="form-check"><input type="checkbox" id="needCase" ${device.needs?.includes('case') ? 'checked' : ''}> × ×¨×ª×™×§</label>
                <label class="form-check"><input type="checkbox" id="needBattery" ${device.needs?.includes('battery') ? 'checked' : ''}> ×¡×•×œ×œ×” ×—×“×©×”</label>
            </div>
        </div>
        <div class="form-group">
            <label>×”×¢×¨×•×ª × ×•×¡×¤×•×ª</label>
            <textarea class="form-control" id="needsNotes" rows="2">${device.needsNotes || ''}</textarea>
        </div>
        <button class="btn btn-success" onclick="saveDeviceNeeds('${deviceId}')">ğŸ’¾ ×©××•×¨</button>
    `;
    openModal('deviceNeedsModal');
}

function saveDeviceNeeds(deviceId) {
    const device = data.devices.find(d => d.id === deviceId);
    const needs = [];
    if (document.getElementById('needCable').checked) needs.push('cable');
    if (document.getElementById('needCharger').checked) needs.push('charger');
    if (document.getElementById('needMagnet').checked) needs.push('magnet');
    if (document.getElementById('needArm').checked) needs.push('arm');
    if (document.getElementById('needCase').checked) needs.push('case');
    if (document.getElementById('needBattery').checked) needs.push('battery');
    
    device.needs = needs;
    device.needsNotes = document.getElementById('needsNotes').value;
    
    saveData();
    updateDevicesTable();
    closeModal('deviceNeedsModal');
}

function filterDevices(filter) {
    document.querySelectorAll('#devices .tab').forEach(t => t.classList.remove('active'));
    event?.target?.classList?.add('active');
    updateDevicesTable(filter);
}

function getStatusName(s) { return {available:'×–××™×Ÿ',rented:'××•×©×›×¨',repair:'×‘×ª×™×§×•×Ÿ'}[s] || s; }
function getTypeName(t) { return {standard:'×¨×’×™×œ',large:'××¡×š ×’×“×•×œ',small:'××¡×š ×§×˜×Ÿ',kosher:'×›×©×¨'}[t] || t || '×¨×’×™×œ'; }

function openDeviceModal(id = null) {
    document.getElementById('editDeviceId').value = id || '';
    document.getElementById('deviceModalTitle').textContent = id ? 'âœï¸ ×¢×¨×™×›×ª ××›×©×™×¨' : 'ğŸ“± ×”×•×¡×¤×ª ××›×©×™×¨';
    document.getElementById('deleteDeviceBtn').style.display = id ? 'inline-block' : 'none';
    
    if (id) {
        const d = data.devices.find(x => x.id === id);
        document.getElementById('deviceNumber').value = d.number || '';
        document.getElementById('deviceModel').value = d.model || '';
        document.getElementById('deviceType').value = d.type || 'standard';
        document.getElementById('devicePrice').value = d.price || 10;
        document.getElementById('deviceSimDate').value = d.simDate || '';
        document.getElementById('deviceCost').value = d.cost || 0;
        document.getElementById('deviceDonor').value = d.donor || '';
        document.getElementById('deviceNotes').value = d.notes || '';
    } else {
        document.getElementById('deviceNumber').value = '';
        document.getElementById('deviceModel').value = '';
        document.getElementById('deviceType').value = 'standard';
        document.getElementById('devicePrice').value = data.settings.defaultPrice || 10;
        document.getElementById('deviceSimDate').value = '';
        document.getElementById('deviceCost').value = 0;
        document.getElementById('deviceDonor').value = '';
        document.getElementById('deviceNotes').value = '';
    }
    openModal('deviceModal');
}

function editDevice(id) { openDeviceModal(id); }

function saveDevice(e) {
    e.preventDefault();
    const id = document.getElementById('editDeviceId').value;
    
    const deviceData = {
        number: document.getElementById('deviceNumber').value,
        model: document.getElementById('deviceModel').value,
        type: document.getElementById('deviceType').value,
        price: parseFloat(document.getElementById('devicePrice').value) || 10,
        simDate: document.getElementById('deviceSimDate').value,
        cost: parseFloat(document.getElementById('deviceCost').value) || 0,
        donor: document.getElementById('deviceDonor').value,
        notes: document.getElementById('deviceNotes').value
    };
    
    if (id) {
        Object.assign(data.devices.find(d => d.id === id), deviceData);
    } else {
        data.devices.push({ id: Date.now().toString(), ...deviceData, status: 'available', revenue: 0, batteryComplaints: 0 });
    }
    
    saveData();
    updateAll();
    closeModal('deviceModal');
    return false;
}

function deleteDevice() {
    const id = document.getElementById('editDeviceId').value;
    if (!id || !confirm('×œ××—×•×§ ××ª ×”××›×©×™×¨?')) return;
    data.devices = data.devices.filter(d => d.id !== id);
    saveData();
    updateAll();
    closeModal('deviceModal');
}

// ×œ×§×•×—×•×ª
function updateCustomersTable(filter = 'all') {
    let filtered = data.customers;
    switch(filter) {
        case 'debt': filtered = data.customers.filter(c => c.debt > 0); break;
        case 'subscription': filtered = data.customers.filter(c => c.subscription > 0); break;
    }
    
    const tbody = document.getElementById('customersTable');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--gray-500)">××™×Ÿ ×œ×§×•×—×•×ª</td></tr>';
        return;
    }
    
    tbody.innerHTML = filtered.map(c => {
        // ×—×™×©×•×‘ ×¡×”"×› ×©×™×œ×
        const totalPaid = data.rentals
            .filter(r => r.customerId === c.id && r.paid)
            .reduce((sum, r) => sum + (r.amount || 0), 0);
        
        return `<tr onclick="openCustomerActions('${c.id}')" style="cursor:pointer">
            <td><strong>${c.name}</strong></td>
            <td>${c.phone}</td>
            <td>${c.rentals || 0}</td>
            <td style="color:var(--success)">â‚ª${totalPaid}</td>
            <td style="color:${c.debt > 0 ? 'var(--danger)' : 'var(--success)'}">â‚ª${c.debt || 0}</td>
            <td>${c.subscription || 0}</td>
            <td>${c.notes || '-'}</td>
            <td><button class="btn btn-sm btn-outline" onclick="event.stopPropagation();openCustomerModal('${c.id}')">âœï¸</button></td>
        </tr>`;
    }).join('');
}

function filterCustomers(filter) {
    document.querySelectorAll('#customers .tab').forEach(t => t.classList.remove('active'));
    event?.target?.classList?.add('active');
    updateCustomersTable(filter);
}

function openCustomerModal(id = null, copyFromRental = false) {
    document.getElementById('editCustomerId').value = id || '';
    document.getElementById('customerModalTitle').textContent = id ? 'âœï¸ ×¢×¨×™×›×ª ×œ×§×•×—' : 'ğŸ‘¤ ×”×•×¡×¤×ª ×œ×§×•×—';
    document.getElementById('deleteCustomerBtn').style.display = id ? 'inline-block' : 'none';
    
    if (id) {
        const c = data.customers.find(x => x.id === id);
        document.getElementById('custName').value = c.name || '';
        document.getElementById('custPhone').value = c.phone || '';
        document.getElementById('custAddress').value = c.address || '';
        document.getElementById('custDebt').value = c.debt || 0;
        document.getElementById('custSubscription').value = c.subscription || 0;
        document.getElementById('custNotes').value = c.notes || '';
    } else if (copyFromRental) {
        // ×”×¢×ª×§ ×¤×¨×˜×™× ××˜×•×¤×¡ ×”×©×›×¨×” ×—×“×©×”
        document.getElementById('custName').value = document.getElementById('customerName')?.value || '';
        document.getElementById('custPhone').value = document.getElementById('customerPhone')?.value || '';
        document.getElementById('custAddress').value = '';
        document.getElementById('custDebt').value = 0;
        document.getElementById('custSubscription').value = 0;
        document.getElementById('custNotes').value = '';
    } else {
        ['custName','custPhone','custAddress','custNotes'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('custDebt').value = 0;
        document.getElementById('custSubscription').value = 0;
    }
    openModal('customerModal');
}

function editCustomer(id) { openCustomerModal(id); }

function saveCustomer(e) {
    e.preventDefault();
    const id = document.getElementById('editCustomerId').value;
    
    const customerData = {
        name: document.getElementById('custName').value,
        phone: document.getElementById('custPhone').value,
        address: document.getElementById('custAddress').value,
        debt: parseFloat(document.getElementById('custDebt').value) || 0,
        subscription: parseInt(document.getElementById('custSubscription').value) || 0,
        notes: document.getElementById('custNotes').value
    };
    
    if (id) {
        Object.assign(data.customers.find(c => c.id === id), customerData);
    } else {
        data.customers.push({ id: Date.now().toString(), ...customerData, rentals: 0 });
    }
    
    saveData();
    updateAll();
    closeModal('customerModal');
    
    // ×—×–×¨×” ×œ××¡×š ×œ×§×•×—×•×ª ×× ×–×” ×œ×§×•×— ×—×“×©
    if (!id) {
        showPage('customers');
    }
    
    return false;
}

function deleteCustomer() {
    const id = document.getElementById('editCustomerId').value;
    if (!id || !confirm('×œ××—×•×§ ××ª ×”×œ×§×•×—?')) return;
    data.customers = data.customers.filter(c => c.id !== id);
    saveData();
    updateAll();
    closeModal('customerModal');
}

// ×¨×©×™××ª ×”××ª× ×”
function updateWaitlistTable() {
    const tbody = document.getElementById('waitlistTable');
    if (data.waitlist.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--gray-500)">××™×Ÿ ×××ª×™× ×™×</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.waitlist.map(w => {
        const hasAvailable = data.devices.some(d => d.status === 'available' && (w.type === 'any' || d.type === w.type));
        return `<tr style="${hasAvailable ? 'background:#D1FAE5' : ''}">
            <td><strong>${w.name}</strong> ${hasAvailable ? 'âœ…' : ''}</td>
            <td>${w.phone}</td>
            <td>${formatDate(w.date)}</td>
            <td>${w.type === 'any' ? '×›×œ ×¡×•×’' : getTypeName(w.type)}</td>
            <td>${w.notes || '-'}</td>
            <td>
                ${hasAvailable ? `<button class="btn btn-sm btn-success" onclick="createRentalFromWaitlist('${w.id}')">ğŸ“± ×”×©×›×¨</button>` : ''}
                <button class="btn btn-sm btn-danger" onclick="removeFromWaitlist('${w.id}')">ğŸ—‘ï¸</button>
            </td>
        </tr>`;
    }).join('');
}

function openWaitlistModal() { openModal('waitlistModal'); }

function addToWaitlist(e) {
    e.preventDefault();
    data.waitlist.push({
        id: Date.now().toString(),
        name: document.getElementById('waitName').value,
        phone: document.getElementById('waitPhone').value,
        type: document.getElementById('waitType').value,
        notes: document.getElementById('waitNotes').value,
        date: new Date().toISOString().split('T')[0]
    });
    saveData();
    updateAll();
    closeModal('waitlistModal');
    document.querySelector('#waitlistModal form').reset();
    return false;
}

function removeFromWaitlist(id) {
    data.waitlist = data.waitlist.filter(w => w.id !== id);
    saveData();
    updateAll();
}

function createRentalFromWaitlist(id) {
    const item = data.waitlist.find(w => w.id === id);
    document.getElementById('customerName').value = item.name;
    document.getElementById('customerPhone').value = item.phone;
    removeFromWaitlist(id);
    showPage('newRental');
}

// ×“×•×—×•×ª
function showReportTab(tab) {
    currentReportTab = tab;
    document.querySelectorAll('#reports .tab').forEach(t => t.classList.remove('active'));
    event?.target?.classList?.add('active');
    generateReport();
}

function generateReport() {
    const from = document.getElementById('reportFrom').value;
    const to = document.getElementById('reportTo').value;
    
    let filtered = data.rentals.filter(r => r.returnDate);
    if (from) filtered = filtered.filter(r => r.startDate >= from);
    if (to) filtered = filtered.filter(r => r.startDate <= to);
    
    const totalRevenue = filtered.filter(r => r.paid).reduce((sum, r) => sum + (r.amount || 0), 0);
    const totalRentals = filtered.length;
    
    let html = '';
    
    if (currentReportTab === 'overview') {
        html = `
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon green">ğŸ’°</div><div class="stat-info"><h3>â‚ª${totalRevenue}</h3><p>×”×›× ×¡×•×ª</p></div></div>
                <div class="stat-card"><div class="stat-icon blue">ğŸ“‹</div><div class="stat-info"><h3>${totalRentals}</h3><p>×”×©×›×¨×•×ª</p></div></div>
                <div class="stat-card"><div class="stat-icon orange">ğŸ“Š</div><div class="stat-info"><h3>â‚ª${totalRentals > 0 ? Math.round(totalRevenue/totalRentals) : 0}</h3><p>×××•×¦×¢ ×œ×”×©×›×¨×”</p></div></div>
            </div>
        `;
    } else if (currentReportTab === 'devices') {
        // ×¤×™×œ×•×— ×œ×¤×™ ××›×©×™×¨
        const deviceStats = {};
        data.devices.forEach(d => {
            deviceStats[d.id] = { 
                number: d.number, 
                revenue: 0, 
                rentals: 0, 
                complaints: d.batteryComplaints || 0,
                model: d.model || ''
            };
        });
        filtered.forEach(r => {
            if (deviceStats[r.deviceId]) {
                deviceStats[r.deviceId].revenue += r.paid ? (r.amount || 0) : 0;
                deviceStats[r.deviceId].rentals++;
            }
        });
        
        html = `<table>
            <thead><tr><th>××›×©×™×¨</th><th>×“×’×</th><th>×”×©×›×¨×•×ª</th><th>×”×›× ×¡×•×ª</th><th>×ª×œ×•× ×•×ª ×¡×•×œ×œ×”</th></tr></thead>
            <tbody>
            ${Object.values(deviceStats).map(d => `
                <tr>
                    <td>${d.number}</td>
                    <td>${d.model}</td>
                    <td>${d.rentals}</td>
                    <td>â‚ª${d.revenue}</td>
                    <td>${d.complaints > 0 ? '<span style="color:var(--danger)">' + d.complaints + '</span>' : '0'}</td>
                </tr>
            `).join('')}
            </tbody>
        </table>`;
    } else if (currentReportTab === 'customers') {
        // ×¤×™×œ×•×— ×œ×¤×™ ×œ×§×•×—
        const customerStats = {};
        data.customers.forEach(c => {
            const custRentals = data.rentals.filter(r => r.customerId === c.id);
            const totalPaid = custRentals.filter(r => r.paid).reduce((sum, r) => sum + (r.amount || 0), 0);
            const lateCount = custRentals.filter(r => r.returnDate && new Date(r.returnDate) > new Date(r.expectedReturn)).length;
            const noChargeCount = custRentals.filter(r => r.returnNotes?.includes('×¡×•×œ×œ×”') || r.complaints?.battery).length;
            
            customerStats[c.id] = {
                name: c.name,
                phone: c.phone,
                rentals: custRentals.length,
                paid: totalPaid,
                debt: c.debt || 0,
                lateCount,
                noChargeCount
            };
        });
        
        // ××™×•×Ÿ ×œ×¤×™ ××¡×¤×¨ ×”×©×›×¨×•×ª
        const sorted = Object.values(customerStats).sort((a, b) => b.rentals - a.rentals);
        
        html = `
            <div class="stats-grid" style="margin-bottom:20px">
                <div class="stat-card"><div class="stat-icon blue">ğŸ‘‘</div><div class="stat-info"><h3>${sorted[0]?.name || '-'}</h3><p>×”×œ×§×•×— ×”×›×™ ××©×›×™×¨</p></div></div>
            </div>
            <table>
            <thead><tr><th>×œ×§×•×—</th><th>×˜×œ×¤×•×Ÿ</th><th>×”×©×›×¨×•×ª</th><th>×©×™×œ× ×¡×”"×›</th><th>×—×•×‘</th><th>××™×—×•×¨×™×</th><th>×”×—×–×™×¨ ×œ×œ× ×˜×¢×™× ×”</th></tr></thead>
            <tbody>
            ${sorted.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.phone}</td>
                    <td>${c.rentals}</td>
                    <td>â‚ª${c.paid}</td>
                    <td>${c.debt > 0 ? '<span style="color:var(--danger)">â‚ª' + c.debt + '</span>' : 'â‚ª0'}</td>
                    <td>${c.lateCount > 0 ? '<span style="color:var(--warning)">' + c.lateCount + '</span>' : '0'}</td>
                    <td>${c.noChargeCount}</td>
                </tr>
            `).join('')}
            </tbody>
        </table>`;
    }
    
    document.getElementById('reportResults').innerHTML = html;
}

function exportReportToExcel() {
    const from = document.getElementById('reportFrom').value;
    const to = document.getElementById('reportTo').value;
    
    let filtered = data.rentals.filter(r => r.returnDate);
    if (from) filtered = filtered.filter(r => r.startDate >= from);
    if (to) filtered = filtered.filter(r => r.startDate <= to);
    
    let csv = '\ufeff'; // BOM for Excel Hebrew
    csv += '××›×©×™×¨,×œ×§×•×—,×”×ª×—×œ×”,×¡×™×•×,×¡×›×•×,×©×•×œ×,×”×¢×¨×•×ª\n';
    filtered.forEach(r => {
        const customer = data.customers.find(c => c.id === r.customerId);
        csv += `${r.deviceNumber},${customer?.name || ''},${r.startDate},${r.returnDate},${r.amount || 0},${r.paid ? '×›×Ÿ' : '×œ×'},${r.returnNotes || ''}\n`;
    });
    
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `×“×•×—-×”×©×›×¨×•×ª-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

// ×™×™×¦×•×
function exportToExcel(type) {
    let csv = '\ufeff';
    if (type === 'devices') {
        csv += '××¡×¤×¨,×“×’×,×¡×•×’,××—×™×¨,×¡×˜×˜×•×¡,×”×›× ×¡×•×ª\n';
        data.devices.forEach(d => csv += `${d.number},${d.model || ''},${getTypeName(d.type)},${d.price || 10},${getStatusName(d.status)},${d.revenue || 0}\n`);
    } else {
        csv += '×©×,×˜×œ×¤×•×Ÿ,×”×©×›×¨×•×ª,×—×•×‘,×× ×•×™\n';
        data.customers.forEach(c => csv += `${c.name},${c.phone},${c.rentals || 0},${c.debt || 0},${c.subscription || 0}\n`);
    }
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `gmach-${type}-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

// ×”×’×“×¨×•×ª
function loadSettings() {
    const s = data.settings;
    document.getElementById('defaultPrice').value = s.defaultPrice || 10;
    document.getElementById('lateFee').value = s.lateFee || 5;
    document.getElementById('skipShabbat').checked = s.skipShabbat !== false;
    document.getElementById('skipHolidays').checked = s.skipHolidays !== false;
    document.getElementById('appPassword').value = s.password || '';
    document.getElementById('ownerName').value = s.ownerName || '';
    document.getElementById('ownerPhone').value = s.ownerPhone || '';
    document.getElementById('ownerCity').value = s.ownerCity || '';
    document.getElementById('ownerDedication').value = s.ownerDedication || '';
    document.getElementById('gmachName').value = s.gmachName || '×’×"×— ×•×•×™×–';
    document.getElementById('gmachSubtitle').value = s.gmachSubtitle || '××©×¤\' ×¦×“×§×”';
    document.getElementById('gmachLogo').value = s.gmachLogo || '×œ×•×’×•.jpg';
    document.getElementById('bgImage').value = s.bgImage || '';
}

function saveSettings() {
    data.settings = {
        ...data.settings, // ×©××™×¨×” ×¢×œ ×”×’×“×¨×•×ª ×§×™×™××•×ª
        defaultPrice: parseFloat(document.getElementById('defaultPrice').value) || 10,
        lateFee: parseFloat(document.getElementById('lateFee').value) || 5,
        skipShabbat: document.getElementById('skipShabbat').checked,
        skipHolidays: document.getElementById('skipHolidays').checked,
        password: document.getElementById('appPassword').value,
        ownerName: document.getElementById('ownerName').value,
        ownerPhone: document.getElementById('ownerPhone').value,
        ownerCity: document.getElementById('ownerCity').value,
        ownerDedication: document.getElementById('ownerDedication').value,
        gmachName: document.getElementById('gmachName').value,
        gmachSubtitle: document.getElementById('gmachSubtitle').value,
        gmachLogo: document.getElementById('gmachLogo').value,
        bgImage: document.getElementById('bgImage').value
    };
    saveData();
    updateBranding();
    alert('âœ… ×”×”×’×“×¨×•×ª × ×©××¨×•!');
}

function exportData() {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `gmach-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function importData(e) {
    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            data = JSON.parse(event.target.result);
            saveData();
            updateAll();
            loadSettings();
            alert('âœ… ×™×•×‘× ×‘×”×¦×œ×—×”!');
        } catch (err) { alert('âŒ ×©×’×™××”'); }
    };
    reader.readAsText(e.target.files[0]);
}

// ×—×™×¤×•×© ×’×œ×•×‘×œ×™
function globalSearch(query) {
    if (!query || query.length < 2) return;
    query = query.toLowerCase();
    
    // ×”×“×’×©×ª ×ª×•×¦××•×ª
    document.querySelectorAll('.highlight-row').forEach(el => el.classList.remove('highlight-row'));
    
    if (data.rentals.some(r => !r.returnDate && r.deviceNumber.toLowerCase().includes(query))) {
        filterRentals('active');
        showPage('rentals');
    } else if (data.customers.some(c => c.name.toLowerCase().includes(query) || c.phone.includes(query))) {
        showPage('customers');
        setTimeout(() => {
            const rows = document.querySelectorAll('#customersTable tr');
            rows.forEach(row => {
                if (row.textContent.toLowerCase().includes(query)) {
                    row.classList.add('highlight-row');
                    row.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            });
        }, 100);
    } else if (data.devices.some(d => d.number.toLowerCase().includes(query))) {
        showPage('devices');
    }
}

// ×”×•×¦××•×ª ×•×”×›× ×¡×•×ª
function openExpenseModal(id = null) {
    document.getElementById('editExpenseId').value = id || '';
    document.getElementById('expenseModalTitle').textContent = id ? 'âœï¸ ×¢×¨×™×›×ª ×¨×©×•××”' : 'ğŸ’¸ ×”×•×¡×¤×ª ×¨×©×•××”';
    document.getElementById('deleteExpenseBtn').style.display = id ? 'inline-flex' : 'none';
    
    // ×¢×“×›×•×Ÿ ×¨×©×™××ª ××›×©×™×¨×™×
    const deviceSelect = document.getElementById('expenseDevice');
    deviceSelect.innerHTML = '<option value="">×œ×œ×</option>' + 
        data.devices.map(d => `<option value="${d.id}">${d.number}</option>`).join('');
    
    if (id) {
        const expense = data.expenses.find(e => e.id === id);
        document.getElementById('expenseType').value = expense.type;
        document.getElementById('expenseDesc').value = expense.description;
        document.getElementById('expenseItem').value = expense.item || '';
        document.getElementById('expenseAmount').value = expense.amount;
        document.getElementById('expenseDate').value = expense.date;
        document.getElementById('expenseDevice').value = expense.deviceId || '';
        document.getElementById('expensePlace').value = expense.place || '';
        document.getElementById('expenseNotes').value = expense.notes || '';
    } else {
        document.getElementById('expenseType').value = 'expense';
        document.getElementById('expenseDesc').value = '';
        document.getElementById('expenseItem').value = '';
        document.getElementById('expenseAmount').value = '';
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('expenseDevice').value = '';
        document.getElementById('expensePlace').value = '';
        document.getElementById('expenseNotes').value = '';
    }
    
    openModal('expenseModal');
}

function saveExpense(e) {
    e.preventDefault();
    const id = document.getElementById('editExpenseId').value;
    
    const expenseData = {
        type: document.getElementById('expenseType').value,
        description: document.getElementById('expenseDesc').value,
        item: document.getElementById('expenseItem').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        date: document.getElementById('expenseDate').value,
        deviceId: document.getElementById('expenseDevice').value,
        place: document.getElementById('expensePlace').value,
        notes: document.getElementById('expenseNotes').value
    };
    
    if (id) {
        Object.assign(data.expenses.find(ex => ex.id === id), expenseData);
    } else {
        data.expenses.push({ id: Date.now().toString(), ...expenseData });
    }
    
    saveData();
    updateExpensesTable();
    closeModal('expenseModal');
    return false;
}

function deleteExpense() {
    const id = document.getElementById('editExpenseId').value;
    if (!confirm('×œ××—×•×§ ×¨×©×•××” ×–×•?')) return;
    data.expenses = data.expenses.filter(e => e.id !== id);
    saveData();
    updateExpensesTable();
    closeModal('expenseModal');
}

let expenseFilter = 'all';
function filterExpenses(type) {
    if (type) expenseFilter = type;
    document.querySelectorAll('#expenses .tab').forEach(t => t.classList.remove('active'));
    event?.target?.classList?.add('active');
    updateExpensesTable();
}

function updateExpensesTable() {
    let filtered = data.expenses || [];
    
    if (expenseFilter === 'expense') filtered = filtered.filter(e => e.type === 'expense');
    if (expenseFilter === 'income') filtered = filtered.filter(e => e.type === 'income');
    
    const dateFilter = document.getElementById('expenseFilterDate')?.value;
    const itemFilter = document.getElementById('expenseFilterItem')?.value?.toLowerCase();
    
    if (dateFilter) filtered = filtered.filter(e => e.date === dateFilter);
    if (itemFilter) filtered = filtered.filter(e => e.item?.toLowerCase().includes(itemFilter) || e.description?.toLowerCase().includes(itemFilter));
    
    // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tbody = document.getElementById('expensesTable');
    tbody.innerHTML = filtered.map(e => {
        const device = data.devices.find(d => d.id === e.deviceId);
        const isExpense = e.type === 'expense';
        return `
            <tr onclick="openExpenseModal('${e.id}')" style="cursor:pointer">
                <td><span class="status-badge ${isExpense ? 'status-repair' : 'status-available'}">${isExpense ? '×”×•×¦××”' : '×”×›× ×¡×”'}</span></td>
                <td>${e.description}</td>
                <td>${e.item || '-'}</td>
                <td style="color:${isExpense ? 'var(--danger)' : 'var(--success)'}">â‚ª${e.amount}</td>
                <td>${formatDate(e.date)}</td>
                <td>${device?.number || '-'}</td>
                <td>${e.place || '-'}</td>
                <td><button class="btn btn-sm btn-outline" onclick="event.stopPropagation();openExpenseModal('${e.id}')">âœï¸</button></td>
            </tr>
        `;
    }).join('') || '<tr><td colspan="8" class="empty-state">××™×Ÿ ×¨×©×•××•×ª</td></tr>';
    
    // ×—×™×©×•×‘ ×¡×”"×›
    const total = filtered.reduce((sum, e) => {
        return sum + (e.type === 'income' ? e.amount : -e.amount);
    }, 0);
    document.getElementById('expensesTotal').textContent = `â‚ª${total}`;
    document.getElementById('expensesTotal').style.color = total >= 0 ? 'var(--success)' : 'var(--danger)';
}

function exportExpensesToExcel() {
    let csv = '\ufeff';
    csv += '×¡×•×’,×ª×™××•×¨,×¤×¨×™×˜,×¡×›×•×,×ª××¨×™×š,××›×©×™×¨,××§×•× ×¨×›×™×©×”,×”×¢×¨×•×ª\n';
    data.expenses.forEach(e => {
        const device = data.devices.find(d => d.id === e.deviceId);
        csv += `${e.type === 'expense' ? '×”×•×¦××”' : '×”×›× ×¡×”'},${e.description},${e.item || ''},${e.amount},${e.date},${device?.number || ''},${e.place || ''},${e.notes || ''}\n`;
    });
    
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `×”×•×¦××•×ª-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

// ×”×•×¨××•×ª
function loadInstructions() {
    document.getElementById('instructionsText').value = data.instructions?.text || '';
    document.getElementById('instructionsImage').value = data.instructions?.image || '';
    updateInstructionsPreview();
}

function saveInstructions() {
    data.instructions = {
        text: document.getElementById('instructionsText').value,
        image: document.getElementById('instructionsImage').value
    };
    saveData();
    updateInstructionsPreview();
    alert('âœ… ×”×”×•×¨××•×ª × ×©××¨×•!');
}

function updateInstructionsPreview() {
    const text = data.instructions?.text || '';
    const image = data.instructions?.image || '';
    let html = '';
    if (text) html += `<div style="white-space:pre-wrap;padding:15px;background:var(--gray-50);border-radius:8px;margin-bottom:15px">${text}</div>`;
    if (image) html += `<img src="${image}" style="max-width:100%;border-radius:8px">`;
    document.getElementById('instructionsPreview').innerHTML = html || '<p style="color:var(--gray-400)">××™×Ÿ ×”×•×¨××•×ª ×¢×“×™×™×Ÿ</p>';
}

// ×”×’×“×¨×•×ª ×¨×§×¢
function setBackground(color) {
    if (color === 'default') {
        document.body.style.background = 'var(--gray-100)';
        data.settings.bgColor = 'default';
    } else {
        document.body.style.background = color;
        data.settings.bgColor = color;
    }
    document.body.style.backgroundImage = '';
    data.settings.bgImage = '';
}

function applyBgImage() {
    const url = document.getElementById('bgImage').value;
    if (url) {
        document.body.style.backgroundImage = `url(${url})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundAttachment = 'fixed';
        data.settings.bgImage = url;
    }
}

// ××™×¤×•×¡ × ×ª×•× ×™×
function resetAllData() {
    if (!confirm('âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?\n\n×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”!')) return;
    if (!confirm('ğŸš¨ ××™×©×•×¨ × ×•×¡×£: ×›×œ ×”××›×©×™×¨×™×, ×”×œ×§×•×—×•×ª, ×”×”×©×›×¨×•×ª ×•×”×”×’×“×¨×•×ª ×™×™××—×§×• ×œ×¦××™×ª×•×ª!')) return;
    
    localStorage.removeItem('gmachWaze');
    data = {
        devices: [],
        customers: [],
        rentals: [],
        waitlist: [],
        expenses: [],
        instructions: { text: '', image: '' },
        settings: {
            defaultPrice: 10,
            lateFee: 5,
            skipShabbat: true,
            skipHolidays: true,
            password: '',
            gmachName: '×’×"×— ×•×•×™×–',
            gmachSubtitle: '××©×¤\' ×¦×“×§×”',
            gmachLogo: '×œ×•×’×•.jpg',
            bgColor: 'default'
        }
    };
    saveData();
    location.reload();
}

// ×¤×¢×•×œ×•×ª ×œ×§×•×—
function openCustomerActions(customerId) {
    const customer = data.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
    const custRentals = data.rentals.filter(r => r.customerId === customerId);
    const totalPaid = custRentals.filter(r => r.paid).reduce((sum, r) => sum + (r.amount || 0), 0);
    const lateCount = custRentals.filter(r => r.returnDate && new Date(r.returnDate) > new Date(r.expectedReturn)).length;
    
    document.getElementById('customerActionsTitle').textContent = customer.name;
    document.getElementById('customerActionsContent').innerHTML = `
        <div style="background:var(--gray-50);padding:15px;border-radius:8px;margin-bottom:15px">
            <p><strong>×˜×œ×¤×•×Ÿ:</strong> ${customer.phone}</p>
            <p><strong>×”×©×›×¨×•×ª:</strong> ${custRentals.length}</p>
            <p><strong>×©×™×œ× ×¡×”"×›:</strong> â‚ª${totalPaid}</p>
            <p><strong>×—×•×‘ × ×•×›×—×™:</strong> ${customer.debt > 0 ? '<span style="color:var(--danger)">â‚ª' + customer.debt + '</span>' : 'â‚ª0'}</p>
            <p><strong>××™×—×•×¨×™×:</strong> ${lateCount}</p>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
            <button class="btn btn-primary" onclick="startRentalForCustomer('${customerId}')">â• ×”×ª×—×œ ×”×©×›×¨×”</button>
            <a href="tel:${customer.phone}" class="btn btn-outline">ğŸ“ ×”×ª×§×©×¨</a>
            ${customer.debt > 0 ? `<button class="btn btn-success" onclick="clearCustomerDebt('${customerId}')">ğŸ’° ××—×§ ×—×•×‘</button>` : ''}
            <button class="btn btn-outline" onclick="openEditCustomer('${customerId}')">âœï¸ ×¢×¨×•×š ×¤×¨×˜×™×</button>
        </div>
    `;
    openModal('customerActionsModal');
}

function startRentalForCustomer(customerId) {
    const customer = data.customers.find(c => c.id === customerId);
    closeModal('customerActionsModal');
    showPage('newRental');
    setTimeout(() => {
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerPhone').value = customer.phone;
    }, 100);
}

function clearCustomerDebt(customerId) {
    if (!confirm('×”×× ×œ××—×•×§ ××ª ×›×œ ×”×—×•×‘ ×©×œ ×œ×§×•×— ×–×”?')) return;
    const customer = data.customers.find(c => c.id === customerId);
    customer.debt = 0;
    saveData();
    updateAll();
    closeModal('customerActionsModal');
    alert('âœ… ×”×—×•×‘ × ××—×§!');
}

function openEditCustomer(customerId) {
    closeModal('customerActionsModal');
    openCustomerModal(customerId);
}

// ×©××™×¨×ª ××›×©×™×¨ ×œ×ª××¨×™×š ××¡×•×™×
function openReserveModal() {
    // ×¢×“×›×•×Ÿ ×¨×©×™××ª ××›×©×™×¨×™×
    document.getElementById('reserveDevice').innerHTML = 
        data.devices.map(d => `<option value="${d.id}">${d.number} - ${d.model || '×¨×’×™×œ'}</option>`).join('');
    document.getElementById('reserveDate').value = new Date().toISOString().split('T')[0];
    openModal('reserveModal');
}

function saveReservation(e) {
    e.preventDefault();
    
    const reservation = {
        id: Date.now().toString(),
        name: document.getElementById('reserveName').value,
        phone: document.getElementById('reservePhone').value,
        deviceId: document.getElementById('reserveDevice').value,
        date: document.getElementById('reserveDate').value,
        notes: document.getElementById('reserveNotes').value,
        type: 'reservation'
    };
    
    data.waitlist.push(reservation);
    saveData();
    updateWaitlistTable();
    closeModal('reserveModal');
    alert('âœ… ×”×©××™×¨×” × ×•×¡×¤×”!');
    return false;
}

// ××•×“×œ×™×
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }));

// ××ª×—×•×œ
document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
