<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×’×"×— ×•×•×™×– - ××©×¤' ×¦×“×§×”</title>
<link rel="icon" type="image/png" href="logo.png">
<style>
:root{--primary:#00D4FF;--primary-dark:#00A8CC;--dark:#2D3436;--success:#00B894;--warning:#FDCB6E;--danger:#E17055;--light:#DFE6E9;--white:#FFF}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,sans-serif}
body{background:linear-gradient(135deg,#00D4FF 0%,#00A8CC 50%,#0984E3 100%);min-height:100vh;padding:15px}
.container{max-width:1400px;margin:0 auto}
header{background:var(--white);border-radius:20px;padding:15px 20px;margin-bottom:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);display:flex;align-items:center;gap:15px;flex-wrap:wrap}
.logo-img{height:70px;border-radius:10px}
h1{color:var(--dark);font-size:1.8em}
.search-box{flex:1;min-width:250px;position:relative}
.search-box input{width:100%;padding:12px 45px 12px 15px;font-size:16px;border:3px solid var(--primary);border-radius:50px;outline:none;transition:.3s}
.search-box input:focus{box-shadow:0 0 15px rgba(0,212,255,0.5)}
.search-box::after{content:"ğŸ”";position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:20px}
nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:15px}
nav button{padding:10px 18px;border:none;border-radius:25px;font-size:14px;cursor:pointer;transition:.3s;background:var(--white);color:var(--dark);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
nav button:hover,nav button.active{background:var(--dark);color:var(--white);transform:translateY(-2px)}
.quick-actions{display:flex;gap:10px;margin-bottom:15px}
.quick-btn{padding:15px 25px;border:none;border-radius:15px;font-size:16px;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:8px;font-weight:bold}
.quick-btn.green{background:linear-gradient(135deg,#00B894,#00A085);color:white}
.quick-btn.red{background:linear-gradient(135deg,#E17055,#D63031);color:white}
.quick-btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,0.2)}
.content{background:var(--white);border-radius:20px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,0.2);min-height:450px}
.page{display:none}
.page.active{display:block}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:var(--white);padding:20px;border-radius:15px;text-align:center;transition:.3s;cursor:pointer}
.stat-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,212,255,0.4)}
.stat-card h3{font-size:2em;margin-bottom:3px}
.stat-card p{opacity:.9;font-size:14px}
.stat-card.warning{background:linear-gradient(135deg,var(--warning) 0%,#F39C12 100%)}
.stat-card.danger{background:linear-gradient(135deg,var(--danger) 0%,#D63031 100%)}
.stat-card.success{background:linear-gradient(135deg,var(--success) 0%,#00A085 100%)}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
.form-group{margin-bottom:12px}
.form-group label{display:block;margin-bottom:5px;font-weight:bold;color:var(--dark);font-size:14px}
.form-group label.required::after{content:" *";color:var(--danger)}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid var(--light);border-radius:8px;font-size:15px;transition:.3s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--primary);box-shadow:0 0 8px rgba(0,212,255,0.3);outline:none}
.checkbox-group{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:10px 0}
.checkbox-group label{display:flex;align-items:center;gap:5px;cursor:pointer;padding:5px 10px;background:var(--light);border-radius:20px;font-size:13px}
.checkbox-group input{width:auto}
.btn{padding:10px 25px;border:none;border-radius:25px;font-size:15px;cursor:pointer;transition:.3s;margin:3px}
.btn-primary{background:var(--primary);color:var(--white)}
.btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px)}
.btn-success{background:var(--success);color:var(--white)}
.btn-danger{background:var(--danger);color:var(--white)}
.btn-warning{background:var(--warning);color:var(--dark)}
.btn-small{padding:6px 12px;font-size:13px}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
th,td{padding:12px 8px;text-align:right;border-bottom:1px solid var(--light)}
th{background:var(--primary);color:var(--white);position:sticky;top:0}
tr:hover{background:rgba(0,212,255,0.1)}
tr.rented{background:rgba(0,184,148,0.1)}
tr.overdue{background:rgba(225,112,85,0.2)}
.status{padding:4px 12px;border-radius:15px;font-size:12px;font-weight:bold;white-space:nowrap}
.status.available{background:#D4EDDA;color:#155724}
.status.rented{background:#CCE5FF;color:#004085}
.status.repair{background:#F8D7DA;color:#721C24}
.alert{padding:12px 15px;border-radius:10px;margin-bottom:12px;display:flex;align-items:center;gap:8px;font-size:14px}
.alert-warning{background:#FFF3CD;color:#856404;border:1px solid #FFE69C}
.alert-danger{background:#F8D7DA;color:#721C24;border:1px solid #F5C6CB}
.alert-success{background:#D4EDDA;color:#155724;border:1px solid #C3E6CB}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;padding:15px}
.modal.active{display:flex}
.modal-content{background:var(--white);padding:25px;border-radius:20px;max-width:650px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid var(--light)}
.modal-close{background:none;border:none;font-size:28px;cursor:pointer;color:var(--dark)}
.autocomplete{position:relative}
.autocomplete-list{position:absolute;top:100%;right:0;left:0;background:var(--white);border:2px solid var(--primary);border-radius:8px;max-height:180px;overflow-y:auto;z-index:100;display:none}
.autocomplete-list.active{display:block}
.autocomplete-item{padding:10px;cursor:pointer;border-bottom:1px solid var(--light)}
.autocomplete-item:hover{background:rgba(0,212,255,0.1)}
.tabs{display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap}
.tab{padding:8px 16px;background:var(--light);border:none;cursor:pointer;font-size:14px;color:var(--dark);transition:.3s;border-radius:20px}
.tab.active{background:var(--primary);color:white}
.rental-card{background:var(--light);border-radius:12px;padding:15px;margin-bottom:12px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
.rental-card.overdue{background:#FFEAEA;border:2px solid var(--danger)}
.rental-info h4{margin-bottom:5px;color:var(--dark)}
.rental-info p{font-size:13px;color:#666;margin:2px 0}
.rental-actions{display:flex;gap:5px;flex-wrap:wrap}
.hebrew-date{font-size:12px;color:#666;margin-top:3px}
.accessory-tag{display:inline-block;padding:3px 8px;background:var(--warning);border-radius:10px;font-size:11px;margin:2px}
.accessory-tag.missing{background:var(--danger);color:white}
.login-screen{display:flex;align-items:center;justify-content:center;min-height:80vh}
.login-box{background:white;padding:40px;border-radius:20px;text-align:center;max-width:400px;width:100%}
.login-box img{max-width:200px;margin-bottom:20px}
.hidden{display:none !important}
@media(max-width:768px){header{flex-direction:column;text-align:center}h1{font-size:1.5em}.form-grid{grid-template-columns:1fr}.quick-actions{flex-direction:column}}
</style>
</head>
<body>

<!-- ××¡×š ×”×ª×—×‘×¨×•×ª -->
<div id="loginScreen" class="login-screen hidden">
<div class="login-box">
<img src="×œ×•×’×•.jpg" alt="×œ×•×’×• ×’×"×— ×•×•×™×–">
<h2>×’×"×— ×•×•×™×– - ××©×¤' ×¦×“×§×”</h2>
<p style="margin:15px 0;color:#666">×”×–×Ÿ ×¡×™×¡××” ×œ×›× ×™×¡×”</p>
<div class="form-group">
<input type="password" id="passwordInput" placeholder="×¡×™×¡××”..." onkeypress="if(event.key==='Enter')checkPassword()">
</div>
<button class="btn btn-primary" onclick="checkPassword()">ğŸ”“ ×›× ×™×¡×”</button>
</div>
</div>

<!-- ×”××¢×¨×›×ª ×”×¨××©×™×ª -->
<div id="mainApp" class="container">
<header>
<img src="×œ×•×’×•.jpg" alt="×œ×•×’×•" class="logo-img">
<div>
<h1>×’×"×— ×•×•×™×– - ××©×¤' ×¦×“×§×”</h1>
<p style="font-size:13px;color:#666">×•×•×™×– ×›×©×¨ ×œ×“×¨×š ×©×œ×š ğŸ“</p>
</div>
<div class="search-box">
<input type="text" id="globalSearch" placeholder="×—×™×¤×•×©: ×©×, ×˜×œ×¤×•×Ÿ, ××¡×¤×¨ ××›×©×™×¨..." oninput="globalSearch(this.value)">
</div>
</header>

<div class="quick-actions">
<button class="quick-btn green" onclick="showPage('newRental')">â• ×”×©×›×¨×” ×—×“×©×”</button>
<button class="quick-btn red" onclick="openEndRentalModal()">ğŸ“¥ ×¡×™×•× ×”×©×›×¨×”</button>
</div>

<nav>
<button class="active" onclick="showPage('dashboard')">ğŸ  ×¨××©×™</button>
<button onclick="showPage('rentals')">ğŸ“‹ ×”×©×›×¨×•×ª</button>
<button onclick="showPage('devices')">ğŸ“± ××›×©×™×¨×™×</button>
<button onclick="showPage('customers')">ğŸ‘¥ ×œ×§×•×—×•×ª</button>
<button onclick="showPage('reports')">ğŸ“ˆ ×“×•×—×•×ª</button>
<button onclick="showPage('settings')">âš™ï¸ ×”×’×“×¨×•×ª</button>
</nav>

<div class="content">
<!-- ×“×©×‘×•×¨×“ -->
<div id="dashboard" class="page active">
<div class="stats" id="statsContainer"></div>
<h3 style="margin:15px 0">ğŸ“‹ ×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª</h3>
<div id="activeRentalsCards"></div>
</div>

<!-- ×”×©×›×¨×” ×—×“×©×” -->
<div id="newRental" class="page">
<h2 style="margin-bottom:15px">â• ×”×©×›×¨×” ×—×“×©×”</h2>
<form id="rentalForm" onsubmit="return createRental(event)">
<div class="form-grid">
<div class="form-group autocomplete">
<label class="required">×©× ×œ×§×•×—</label>
<input type="text" id="customerName" required oninput="searchCustomers(this.value)" autocomplete="off">
<div class="autocomplete-list" id="customerSuggestions"></div>
</div>
<div class="form-group">
<label class="required">×˜×œ×¤×•×Ÿ</label>
<input type="tel" id="customerPhone" required>
</div>
<div class="form-group">
<label class="required">××›×©×™×¨</label>
<select id="deviceSelect" required>
<option value="">×‘×—×¨ ××›×©×™×¨...</option>
</select>
</div>
<div class="form-group">
<label>××©×š ×”×”×©×›×¨×”</label>
<select id="rentalDuration" onchange="updateReturnDate()">
<option value="1">×™×•× ××—×“</option>
<option value="2">×™×•××™×™×</option>
<option value="3">3 ×™××™×</option>
<option value="4">4 ×™××™×</option>
<option value="5">5 ×™××™×</option>
<option value="6">6 ×™××™×</option>
<option value="7">×©×‘×•×¢</option>
<option value="14">×©×‘×•×¢×™×™×</option>
<option value="custom">×ª××¨×™×š ×¡×¤×¦×™×¤×™</option>
</select>
</div>
<div class="form-group" id="customDateGroup" style="display:none">
<label>×ª××¨×™×š ×”×—×–×¨×”</label>
<input type="date" id="customReturnDate">
</div>
<div class="form-group">
<label>××—×™×¨ (â‚ª)</label>
<input type="number" id="rentalPrice" value="10">
</div>
</div>
<h4 style="margin:15px 0">×¦×™×•×“ × ×œ×•×•×”</h4>
<div class="checkbox-group" id="accessoriesGroup">
<label><input type="checkbox" id="accCable" checked> ×›×‘×œ ×˜×¢×™× ×”</label>
<label><input type="checkbox" id="accCaseBig"> × ×¨×ª×™×§ ×’×“×•×œ</label>
<label><input type="checkbox" id="accCaseSmall"> × ×¨×ª×™×§ ×§×˜×Ÿ</label>
<label><input type="checkbox" id="accCarCharger"> ××¦×ª ×œ×¨×›×‘</label>
<label><input type="checkbox" id="accMagnet"> ××’× ×˜ ×œ×¨×›×‘</label>
<label><input type="checkbox" id="accArm"> ×–×¨×•×¢ ×œ×¨×›×‘</label>
</div>
<div class="form-group">
<label>××‘×™×–×¨ × ×œ×•×•×” × ×•×¡×£</label>
<input type="text" id="accCustom" placeholder="×¤×¨×˜ ××‘×™×–×¨ × ×•×¡×£...">
</div>
<div class="form-group">
<label>×”×¢×¨×•×ª</label>
<textarea id="rentalNotes" rows="2" placeholder="×”×¢×¨×•×ª ×œ×”×©×›×¨×”..."></textarea>
</div>
<button type="submit" class="btn btn-success">âœ… ××©×¨ ×”×©×›×¨×”</button>
<button type="button" class="btn btn-warning" onclick="clearRentalForm()">ğŸ”„ × ×§×”</button>
</form>
</div>

<!-- ×”×©×›×¨×•×ª -->
<div id="rentals" class="page">
<h2 style="margin-bottom:15px">ğŸ“‹ × ×™×”×•×œ ×”×©×›×¨×•×ª</h2>
<div class="tabs">
<button class="tab active" onclick="filterRentals('active')">×¤×¢×™×œ×•×ª</button>
<button class="tab" onclick="filterRentals('overdue')">×‘××™×—×•×¨</button>
<button class="tab" onclick="filterRentals('returned')">×”×•×—×–×¨×•</button>
<button class="tab" onclick="filterRentals('all')">×”×›×œ</button>
</div>
<div id="rentalsContainer"></div>
</div>

<!-- ××›×©×™×¨×™× -->
<div id="devices" class="page">
<h2 style="margin-bottom:15px">ğŸ“± × ×™×”×•×œ ××›×©×™×¨×™×</h2>
<button class="btn btn-primary" onclick="openDeviceModal()">â• ×”×•×¡×£ ××›×©×™×¨</button>
<button class="btn btn-success" onclick="exportToExcel('devices')">ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ</button>
<div class="tabs" style="margin-top:15px">
<button class="tab active" onclick="filterDevices('all')">×”×›×œ</button>
<button class="tab" onclick="filterDevices('available')">×–××™× ×™×</button>
<button class="tab" onclick="filterDevices('rented')">××•×©×›×¨×™×</button>
<button class="tab" onclick="filterDevices('repair')">×‘×ª×™×§×•×Ÿ</button>
</div>
<table>
<thead><tr><th>××¡×¤×¨</th><th>×“×’×/×¡×•×’</th><th>×’×•×“×œ ××¡×š</th><th>××—×™×¨</th><th>×¡×˜×˜×•×¡</th><th>×”×›× ×¡×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
<tbody id="devicesTable"></tbody>
</table>
</div>

<!-- ×œ×§×•×—×•×ª -->
<div id="customers" class="page">
<h2 style="margin-bottom:15px">ğŸ‘¥ × ×™×”×•×œ ×œ×§×•×—×•×ª</h2>
<button class="btn btn-primary" onclick="openCustomerModal()">â• ×”×•×¡×£ ×œ×§×•×—</button>
<button class="btn btn-success" onclick="exportToExcel('customers')">ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ</button>
<div class="tabs" style="margin-top:15px">
<button class="tab active" onclick="filterCustomers('all')">×”×›×œ</button>
<button class="tab" onclick="filterCustomers('debt')">×—×™×™×‘×™×</button>
<button class="tab" onclick="filterCustomers('issues')">×‘×¢×™×•×ª ×¦×™×•×“</button>
</div>
<table>
<thead><tr><th>×©×</th><th>×˜×œ×¤×•×Ÿ</th><th>×”×©×›×¨×•×ª</th><th>×—×•×‘</th><th>×‘×¢×™×•×ª ×¦×™×•×“</th><th>×”×¢×¨×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
<tbody id="customersTable"></tbody>
</table>
</div>

<!-- ×“×•×—×•×ª -->
<div id="reports" class="page">
<h2 style="margin-bottom:15px">ğŸ“ˆ ×“×•×—×•×ª</h2>
<div class="form-grid" style="margin-bottom:15px">
<div class="form-group">
<label>××ª××¨×™×š</label>
<input type="date" id="reportFrom">
</div>
<div class="form-group">
<label>×¢×“ ×ª××¨×™×š</label>
<input type="date" id="reportTo">
</div>
<div class="form-group">
<button class="btn btn-primary" onclick="generateReport()" style="margin-top:22px">ğŸ“Š ×”×¤×§ ×“×•×—</button>
</div>
</div>
<div id="reportResults"></div>
</div>

<!-- ×”×’×“×¨×•×ª -->
<div id="settings" class="page">
<h2 style="margin-bottom:15px">âš™ï¸ ×”×’×“×¨×•×ª</h2>

<h4 style="margin:15px 0;color:var(--primary)">×¤×¨×˜×™ ×”×’×"×—</h4>
<div class="form-grid">
<div class="form-group">
<label>×©× ×‘×¢×œ ×”×’×"×—</label>
<input type="text" id="ownerName">
</div>
<div class="form-group">
<label>×˜×œ×¤×•×Ÿ</label>
<input type="tel" id="ownerPhone">
</div>
<div class="form-group">
<label>×¢×™×¨</label>
<input type="text" id="ownerCity">
</div>
<div class="form-group">
<label>×œ×¢×™×œ×•×™ × ×©××ª</label>
<input type="text" id="ownerDedication">
</div>
</div>

<h4 style="margin:15px 0;color:var(--primary)">×”×’×“×¨×•×ª ×”×©×›×¨×”</h4>
<div class="form-grid">
<div class="form-group">
<label>××—×™×¨ ×‘×¨×™×¨×ª ××—×“×œ ×œ×™×•× (â‚ª)</label>
<input type="number" id="defaultPrice" value="10">
</div>
<div class="form-group">
<label>××©×š ×”×©×›×¨×” ×‘×¨×™×¨×ª ××—×“×œ (×™××™×)</label>
<input type="number" id="defaultDays" value="1">
</div>
<div class="form-group">
<label>×§× ×¡ ××™×—×•×¨ ×œ×™×•× (â‚ª)</label>
<input type="number" id="lateFee" value="5">
</div>
</div>

<h4 style="margin:15px 0;color:var(--primary)">×¦×™×•×“ × ×œ×•×•×” ×‘×¨×™×¨×ª ××—×“×œ</h4>
<div class="checkbox-group">
<label><input type="checkbox" id="defCable" checked> ×›×‘×œ ×˜×¢×™× ×”</label>
<label><input type="checkbox" id="defCaseBig"> × ×¨×ª×™×§ ×’×“×•×œ</label>
<label><input type="checkbox" id="defCaseSmall"> × ×¨×ª×™×§ ×§×˜×Ÿ</label>
<label><input type="checkbox" id="defCarCharger"> ××¦×ª ×œ×¨×›×‘</label>
<label><input type="checkbox" id="defMagnet"> ××’× ×˜ ×œ×¨×›×‘</label>
<label><input type="checkbox" id="defArm"> ×–×¨×•×¢ ×œ×¨×›×‘</label>
</div>

<h4 style="margin:15px 0;color:var(--primary)">××‘×˜×—×”</h4>
<div class="form-grid">
<div class="form-group">
<label>×¡×™×¡××ª ×›× ×™×¡×” (×”×©××¨ ×¨×™×§ ×œ×‘×™×˜×•×œ)</label>
<input type="password" id="appPassword" placeholder="×¡×™×¡××”...">
</div>
</div>

<button class="btn btn-success" onclick="saveSettings()" style="margin-top:15px">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>

<hr style="margin:25px 0">
<h4>ğŸ“¥ ×™×™×¦×•×/×™×™×‘×•× × ×ª×•× ×™×</h4>
<button class="btn btn-primary" onclick="exportData()">ğŸ“¤ ×™×™×¦× ×’×™×‘×•×™</button>
<button class="btn btn-warning" onclick="document.getElementById('importFile').click()">ğŸ“¥ ×™×™×‘× ×’×™×‘×•×™</button>
<input type="file" id="importFile" style="display:none" onchange="importData(event)" accept=".json">
</div>
</div>
</div>

<!-- ××•×“×œ×™× -->
<!-- ×¡×™×•× ×”×©×›×¨×” -->
<div id="endRentalModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>ğŸ“¥ ×¡×™×•× ×”×©×›×¨×”</h2>
<button class="modal-close" onclick="closeModal('endRentalModal')">&times;</button>
</div>
<div class="form-group">
<label>×‘×—×¨ ××›×©×™×¨ ×œ×”×—×–×¨×”</label>
<select id="endRentalSelect" onchange="showEndRentalDetails()">
<option value="">×‘×—×¨ ××›×©×™×¨ ××•×©×›×¨...</option>
</select>
</div>
<div id="endRentalDetails" style="display:none">
<div style="background:var(--light);padding:15px;border-radius:10px;margin:15px 0" id="endRentalInfo"></div>
<h4 style="margin:10px 0">×¦×™×•×“ ×©×”×•×—×–×¨</h4>
<div class="checkbox-group" id="returnAccessories"></div>
<div class="form-group">
<label>×¡×›×•× ×œ×ª×©×œ×•× (â‚ª)</label>
<input type="number" id="endRentalAmount" readonly>
</div>
<div class="checkbox-group">
<label><input type="checkbox" id="endRentalPaid"> ×©×•×œ×</label>
</div>
<div class="form-group">
<label>×”×¢×¨×•×ª ×”×—×–×¨×”</label>
<textarea id="endRentalNotes" rows="2" placeholder="×‘×¢×™×•×ª, ×¦×™×•×“ ×—×¡×¨..."></textarea>
</div>
<button class="btn btn-success" onclick="processEndRental()">âœ… ××©×¨ ×”×—×–×¨×”</button>
<button class="btn btn-danger" onclick="cancelRental()">âŒ ×‘×˜×œ ×”×©×›×¨×”</button>
</div>
</div>
</div>

<!-- ×¢×¨×™×›×ª ×”×©×›×¨×” -->
<div id="editRentalModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>âœï¸ ×¢×¨×™×›×ª ×”×©×›×¨×”</h2>
<button class="modal-close" onclick="closeModal('editRentalModal')">&times;</button>
</div>
<input type="hidden" id="editRentalId">
<div id="editRentalContent"></div>
</div>
</div>

<!-- ××›×©×™×¨ -->
<div id="deviceModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="deviceModalTitle">ğŸ“± ×”×•×¡×¤×ª ××›×©×™×¨</h2>
<button class="modal-close" onclick="closeModal('deviceModal')">&times;</button>
</div>
<form onsubmit="return saveDevice(event)">
<input type="hidden" id="editDeviceId">
<div class="form-grid">
<div class="form-group">
<label class="required">××¡×¤×¨ ××›×©×™×¨</label>
<input type="text" id="deviceNumber" required>
</div>
<div class="form-group">
<label>×“×’×</label>
<input type="text" id="deviceModel" placeholder="×œ××©×œ: Garmin nuvi">
</div>
<div class="form-group">
<label>×¡×•×’</label>
<select id="deviceType">
<option value="standard">×¨×’×™×œ</option>
<option value="large">××¡×š ×’×“×•×œ</option>
<option value="small">××¡×š ×§×˜×Ÿ</option>
<option value="kosher">×›×©×¨ (×—×¡×•×)</option>
</select>
</div>
<div class="form-group">
<label>×’×•×“×œ ××¡×š</label>
<input type="text" id="deviceScreen" placeholder='×œ××©×œ: 5"'>
</div>
<div class="form-group">
<label>××—×™×¨ ×œ×™×•× (â‚ª)</label>
<input type="number" id="devicePrice" value="10">
</div>
<div class="form-group">
<label>× ×¤×¨×¥?</label>
<select id="deviceUnlocked">
<option value="no">×œ×</option>
<option value="yes">×›×Ÿ</option>
</select>
</div>
</div>
<div class="form-group">
<label>× ×ª×¨× ×¢"×™ / ×œ×¢×™×œ×•×™ × ×©××ª</label>
<input type="text" id="deviceDonor" placeholder="×©× ×”×ª×•×¨×...">
</div>
<div class="form-group">
<label>×”×¢×¨×•×ª</label>
<textarea id="deviceNotes" rows="2"></textarea>
</div>
<button type="submit" class="btn btn-success">ğŸ’¾ ×©××•×¨</button>
<button type="button" class="btn btn-danger" onclick="deleteDevice()" id="deleteDeviceBtn" style="display:none">ğŸ—‘ï¸ ××—×§</button>
</form>
</div>
</div>

<!-- ×œ×§×•×— -->
<div id="customerModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="customerModalTitle">ğŸ‘¤ ×”×•×¡×¤×ª ×œ×§×•×—</h2>
<button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
</div>
<form onsubmit="return saveCustomer(event)">
<input type="hidden" id="editCustomerId">
<div class="form-grid">
<div class="form-group">
<label class="required">×©× ××œ×</label>
<input type="text" id="custName" required>
</div>
<div class="form-group">
<label class="required">×˜×œ×¤×•×Ÿ</label>
<input type="tel" id="custPhone" required>
</div>
<div class="form-group">
<label>×›×ª×•×‘×ª</label>
<input type="text" id="custAddress">
</div>
<div class="form-group">
<label>×—×•×‘ (â‚ª)</label>
<input type="number" id="custDebt" value="0">
</div>
</div>
<h4 style="margin:10px 0">×‘×¢×™×•×ª ×¦×™×•×“</h4>
<div class="checkbox-group">
<label><input type="checkbox" id="custMissingCable"> ××™×‘×“ ×›×‘×œ ×˜×¢×™× ×”</label>
<label><input type="checkbox" id="custMissingCase"> ×œ× ×”×—×–×™×¨ × ×¨×ª×™×§</label>
<label><input type="checkbox" id="custDirtyCase"> × ×¨×ª×™×§ ××œ×•×›×œ×š</label>
<label><input type="checkbox" id="custMissingCharger"> ×œ× ×”×—×–×™×¨ ××¦×ª</label>
<label><input type="checkbox" id="custMissingMagnet"> ×œ× ×”×—×–×™×¨ ××’× ×˜</label>
<label><input type="checkbox" id="custMissingArm"> ×œ× ×”×—×–×™×¨ ×–×¨×•×¢</label>
</div>
<div class="form-group">
<label>××‘×™×–×¨ ×—×¡×¨ ××—×¨</label>
<input type="text" id="custMissingOther" placeholder="×¤×¨×˜...">
</div>
<div class="form-group">
<label>×¡×˜×˜×•×¡ ×ª×©×œ×•× ×¢×œ ×¦×™×•×“ ×—×¡×¨</label>
<select id="custEquipmentPaid">
<option value="none">××™×Ÿ ×—×•×‘ ×¢×œ ×¦×™×•×“</option>
<option value="pending">×¦×¨×™×š ×œ×©×œ×</option>
<option value="paid">×©×™×œ×</option>
</select>
</div>
<div class="form-group">
<label>×”×¢×¨×•×ª</label>
<textarea id="custNotes" rows="2" placeholder="×”×¢×¨×•×ª ×¢×œ ×”×œ×§×•×—..."></textarea>
</div>
<button type="submit" class="btn btn-success">ğŸ’¾ ×©××•×¨</button>
<button type="button" class="btn btn-danger" onclick="deleteCustomer()" id="deleteCustomerBtn" style="display:none">ğŸ—‘ï¸ ××—×§</button>
</form>
</div>
</div>

<script>
// ×”××¨×ª ×ª××¨×™×š ×œ×¢×‘×¨×™
function toHebrewDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const months = ['×ª×©×¨×™','×—×©×•×•×Ÿ','×›×¡×œ×•','×˜×‘×ª','×©×‘×˜','××“×¨','× ×™×¡×Ÿ','××™×™×¨','×¡×™×•×•×Ÿ','×ª××•×–','××‘','××œ×•×œ'];
    const days = ['×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×™×','×™×‘','×™×’','×™×“','×˜×•','×˜×–','×™×–','×™×—','×™×˜','×›','×›×','×›×‘','×›×’','×›×“','×›×”','×›×•','×›×–','×›×—','×›×˜','×œ'];
    
    // ×—×™×©×•×‘ ×¤×©×•×˜ - ×ª××¨×™×š ×¢×‘×¨×™ ××©×•×¢×¨
    const hebrewYear = date.getFullYear() + 3760;
    const day = date.getDate();
    const month = date.getMonth();
    
    // ××™×¤×•×™ ×—×•×“×©×™× ×œ×•×¢×–×™×™× ×œ×¢×‘×¨×™×™× (××©×•×¢×¨)
    const hebrewMonths = ['×˜×‘×ª','×©×‘×˜','××“×¨','× ×™×¡×Ÿ','××™×™×¨','×¡×™×•×•×Ÿ','×ª××•×–','××‘','××œ×•×œ','×ª×©×¨×™','×—×©×•×•×Ÿ','×›×¡×œ×•'];
    
    return `${days[day-1] || day} ${hebrewMonths[month]} ${hebrewYear}`;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('he-IL');
}

// × ×ª×•× ×™×
let data = {
    devices: [],
    customers: [],
    rentals: [],
    settings: {
        defaultPrice: 10,
        defaultDays: 1,
        lateFee: 5,
        password: '',
        ownerName: '',
        ownerPhone: '',
        ownerCity: '',
        ownerDedication: '',
        defaultAccessories: {cable: true}
    }
};

// ×˜×¢×™× ×” ×•×©××™×¨×”
function loadData() {
    const saved = localStorage.getItem('gmachWaze');
    if (saved) data = JSON.parse(saved);
    
    // ×‘×“×™×§×ª ×¡×™×¡××”
    if (data.settings.password) {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }
    
    updateAll();
    loadSettings();
}

function saveData() {
    localStorage.setItem('gmachWaze', JSON.stringify(data));
}

function checkPassword() {
    const input = document.getElementById('passwordInput').value;
    if (input === data.settings.password) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
    } else {
        alert('×¡×™×¡××” ×©×’×•×™×”!');
    }
}

// × ×™×•×•×˜
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    if (event && event.target.tagName === 'BUTTON') event.target.classList.add('active');
    updateAll();
}

// ×¢×“×›×•×Ÿ ×›×œ×œ×™
function updateAll() {
    updateStats();
    updateActiveRentals();
    updateRentalsPage();
    updateDevicesTable();
    updateCustomersTable();
    updateDeviceSelects();
}

// ×¡×˜×˜×™×¡×˜×™×§×•×ª
function updateStats() {
    const available = data.devices.filter(d => d.status === 'available').length;
    const rented = data.rentals.filter(r => !r.returnDate).length;
    const overdue = data.rentals.filter(r => !r.returnDate && new Date(r.expectedReturn) < new Date()).length;
    const totalDebt = data.customers.reduce((sum, c) => sum + (c.debt || 0), 0);
    
    document.getElementById('statsContainer').innerHTML = `
        <div class="stat-card success" onclick="filterDevices('available');showPage('devices')">
            <h3>${available}</h3><p>×–××™× ×™×</p>
        </div>
        <div class="stat-card" onclick="filterRentals('active');showPage('rentals')">
            <h3>${rented}</h3><p>××•×©×›×¨×™×</p>
        </div>
        <div class="stat-card ${overdue > 0 ? 'danger' : ''}" onclick="filterRentals('overdue');showPage('rentals')">
            <h3>${overdue}</h3><p>×‘××™×—×•×¨</p>
        </div>
        <div class="stat-card ${totalDebt > 0 ? 'warning' : 'success'}" onclick="filterCustomers('debt');showPage('customers')">
            <h3>â‚ª${totalDebt}</h3><p>×—×•×‘×•×ª</p>
        </div>
    `;
}

// ×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª ×‘×“×©×‘×•×¨×“
function updateActiveRentals() {
    const active = data.rentals.filter(r => !r.returnDate);
    const container = document.getElementById('activeRentalsCards');
    
    if (active.length === 0) {
        container.innerHTML = '<div class="alert alert-success">âœ… ××™×Ÿ ×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢</div>';
        return;
    }
    
    container.innerHTML = active.map(r => {
        const customer = data.customers.find(c => c.id === r.customerId);
        const isOverdue = new Date(r.expectedReturn) < new Date();
        
        return `
        <div class="rental-card ${isOverdue ? 'overdue' : ''}">
            <div class="rental-info">
                <h4>${customer?.name || '×œ×§×•×— ×œ× ×™×“×•×¢'} - ××›×©×™×¨ ${r.deviceNumber}</h4>
                <p>ğŸ“ ${customer?.phone || ''}</p>
                <p>ğŸ“… ×”×ª×—×œ×”: ${formatDate(r.startDate)} <span class="hebrew-date">(${toHebrewDate(r.startDate)})</span></p>
                <p>ğŸ“… ×”×—×–×¨×”: ${formatDate(r.expectedReturn)} <span class="hebrew-date">(${toHebrewDate(r.expectedReturn)})</span></p>
                ${isOverdue ? '<p style="color:var(--danger);font-weight:bold">âš ï¸ ×‘××™×—×•×¨!</p>' : ''}
            </div>
            <div class="rental-actions">
                <button class="btn btn-primary btn-small" onclick="openEditRental('${r.id}')">âœï¸ ×¢×¨×•×š</button>
                <button class="btn btn-success btn-small" onclick="quickEndRental('${r.id}')">ğŸ“¥ ×”×—×–×¨</button>
            </div>
        </div>`;
    }).join('');
}

// ×¢×“×›×•×Ÿ ×ª××¨×™×š ×”×—×–×¨×” ×œ×¤×™ ×™××™×
function updateReturnDate() {
    const duration = document.getElementById('rentalDuration').value;
    const customGroup = document.getElementById('customDateGroup');
    
    if (duration === 'custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
}

// ×‘×—×™×¨×•×ª ××›×©×™×¨×™×
function updateDeviceSelects() {
    const available = data.devices.filter(d => d.status === 'available');
    const rented = data.rentals.filter(r => !r.returnDate);
    
    // ×‘×—×™×¨×” ×œ×”×©×›×¨×”
    const select = document.getElementById('deviceSelect');
    if (select) {
        select.innerHTML = '<option value="">×‘×—×¨ ××›×©×™×¨...</option>' +
            available.map(d => `<option value="${d.id}">${d.number} - ${d.model || d.type || '×¨×’×™×œ'}</option>`).join('');
    }
    
    // ×‘×—×™×¨×” ×œ×¡×™×•× ×”×©×›×¨×”
    const endSelect = document.getElementById('endRentalSelect');
    if (endSelect) {
        endSelect.innerHTML = '<option value="">×‘×—×¨ ××›×©×™×¨ ××•×©×›×¨...</option>' +
            rented.map(r => {
                const customer = data.customers.find(c => c.id === r.customerId);
                return `<option value="${r.id}">××›×©×™×¨ ${r.deviceNumber} - ${customer?.name || '×œ×§×•×—'}</option>`;
            }).join('');
    }
}

// ×—×™×¤×•×© ×œ×§×•×—×•×ª
function searchCustomers(query) {
    const suggestions = document.getElementById('customerSuggestions');
    if (!query || query.length < 2) {
        suggestions.classList.remove('active');
        return;
    }
    
    const matches = data.customers.filter(c => 
        c.name.toLowerCase().includes(query.toLowerCase()) || c.phone.includes(query)
    );
    
    if (matches.length > 0) {
        suggestions.innerHTML = matches.map(c => 
            `<div class="autocomplete-item" onclick="selectCustomer('${c.id}')">${c.name} - ${c.phone}</div>`
        ).join('');
        suggestions.classList.add('active');
    } else {
        suggestions.innerHTML = '<div class="autocomplete-item" onclick="openCustomerModal()">â• ×”×•×¡×£ ×œ×§×•×— ×—×“×©</div>';
        suggestions.classList.add('active');
    }
}

function selectCustomer(id) {
    const customer = data.customers.find(c => c.id === id);
    if (customer) {
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerPhone').value = customer.phone;
        document.getElementById('customerSuggestions').classList.remove('active');
    }
}

// ×™×¦×™×¨×ª ×”×©×›×¨×”
function createRental(e) {
    e.preventDefault();
    
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const deviceId = document.getElementById('deviceSelect').value;
    
    if (!name || !phone || !deviceId) {
        alert('× × ×œ××œ× ×©×, ×˜×œ×¤×•×Ÿ ×•×œ×‘×—×•×¨ ××›×©×™×¨!');
        return false;
    }
    
    // ×œ×§×•×—
    let customer = data.customers.find(c => c.phone === phone);
    if (!customer) {
        customer = {
            id: Date.now().toString(),
            name: name,
            phone: phone,
            rentals: 0,
            debt: 0
        };
        data.customers.push(customer);
    } else {
        customer.name = name;
    }
    
    // ×ª××¨×™×›×™×
    const startDate = new Date().toISOString().split('T')[0];
    let expectedReturn;
    const duration = document.getElementById('rentalDuration').value;
    
    if (duration === 'custom') {
        expectedReturn = document.getElementById('customReturnDate').value;
    } else {
        const returnDate = new Date();
        returnDate.setDate(returnDate.getDate() + parseInt(duration));
        expectedReturn = returnDate.toISOString().split('T')[0];
    }
    
    // ××›×©×™×¨
    const device = data.devices.find(d => d.id === deviceId);
    device.status = 'rented';
    
    // ×¦×™×•×“ × ×œ×•×•×”
    const accessories = {
        cable: document.getElementById('accCable')?.checked,
        caseBig: document.getElementById('accCaseBig')?.checked,
        caseSmall: document.getElementById('accCaseSmall')?.checked,
        carCharger: document.getElementById('accCarCharger')?.checked,
        magnet: document.getElementById('accMagnet')?.checked,
        arm: document.getElementById('accArm')?.checked,
        custom: document.getElementById('accCustom')?.value || ''
    };
    
    // ×”×©×›×¨×”
    const rental = {
        id: Date.now().toString(),
        customerId: customer.id,
        deviceId: deviceId,
        deviceNumber: device.number,
        startDate: startDate,
        expectedReturn: expectedReturn,
        returnDate: null,
        price: parseFloat(document.getElementById('rentalPrice').value) || 10,
        amount: null,
        paid: false,
        accessories: accessories,
        notes: document.getElementById('rentalNotes').value
    };
    
    data.rentals.push(rental);
    customer.rentals = (customer.rentals || 0) + 1;
    
    saveData();
    updateAll();
    clearRentalForm();
    alert('âœ… ×”×”×©×›×¨×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
    showPage('dashboard');
    return false;
}

function clearRentalForm() {
    document.getElementById('rentalForm').reset();
    document.getElementById('customDateGroup').style.display = 'none';
    loadDefaultAccessories();
}

function loadDefaultAccessories() {
    const def = data.settings.defaultAccessories || {};
    document.getElementById('accCable').checked = def.cable || false;
    document.getElementById('accCaseBig').checked = def.caseBig || false;
    document.getElementById('accCaseSmall').checked = def.caseSmall || false;
    document.getElementById('accCarCharger').checked = def.carCharger || false;
    document.getElementById('accMagnet').checked = def.magnet || false;
    document.getElementById('accArm').checked = def.arm || false;
}

// ×¡×™×•× ×”×©×›×¨×”
function openEndRentalModal() {
    updateDeviceSelects();
    document.getElementById('endRentalDetails').style.display = 'none';
    openModal('endRentalModal');
}

function showEndRentalDetails() {
    const rentalId = document.getElementById('endRentalSelect').value;
    if (!rentalId) {
        document.getElementById('endRentalDetails').style.display = 'none';
        return;
    }
    
    const rental = data.rentals.find(r => r.id === rentalId);
    const customer = data.customers.find(c => c.id === rental.customerId);
    
    document.getElementById('endRentalInfo').innerHTML = `
        <p><strong>×œ×§×•×—:</strong> ${customer?.name || '×œ× ×™×“×•×¢'}</p>
        <p><strong>×˜×œ×¤×•×Ÿ:</strong> ${customer?.phone || ''}</p>
        <p><strong>××›×©×™×¨:</strong> ${rental.deviceNumber}</p>
        <p><strong>×”×ª×—×œ×”:</strong> ${formatDate(rental.startDate)} (${toHebrewDate(rental.startDate)})</p>
        <p><strong>×”×—×–×¨×” ×¦×¤×•×™×”:</strong> ${formatDate(rental.expectedReturn)} (${toHebrewDate(rental.expectedReturn)})</p>
    `;
    
    // ×¦×™×•×“
    const acc = rental.accessories || {};
    document.getElementById('returnAccessories').innerHTML = `
        ${acc.cable ? '<label><input type="checkbox" id="retCable" checked> ×›×‘×œ ×˜×¢×™× ×”</label>' : ''}
        ${acc.caseBig ? '<label><input type="checkbox" id="retCaseBig" checked> × ×¨×ª×™×§ ×’×“×•×œ</label>' : ''}
        ${acc.caseSmall ? '<label><input type="checkbox" id="retCaseSmall" checked> × ×¨×ª×™×§ ×§×˜×Ÿ</label>' : ''}
        ${acc.carCharger ? '<label><input type="checkbox" id="retCarCharger" checked> ××¦×ª ×œ×¨×›×‘</label>' : ''}
        ${acc.magnet ? '<label><input type="checkbox" id="retMagnet" checked> ××’× ×˜ ×œ×¨×›×‘</label>' : ''}
        ${acc.arm ? '<label><input type="checkbox" id="retArm" checked> ×–×¨×•×¢ ×œ×¨×›×‘</label>' : ''}
        ${acc.custom ? `<label><input type="checkbox" id="retCustom" checked> ${acc.custom}</label>` : ''}
    `;
    
    // ×—×™×©×•×‘ ×¡×›×•×
    const days = Math.ceil((new Date() - new Date(rental.startDate)) / (1000 * 60 * 60 * 24));
    let amount = days * rental.price;
    
    if (new Date() > new Date(rental.expectedReturn)) {
        const lateDays = Math.ceil((new Date() - new Date(rental.expectedReturn)) / (1000 * 60 * 60 * 24));
        amount += lateDays * (data.settings.lateFee || 5);
    }
    
    document.getElementById('endRentalAmount').value = Math.max(rental.price, amount);
    document.getElementById('endRentalDetails').style.display = 'block';
}

function processEndRental() {
    const rentalId = document.getElementById('endRentalSelect').value;
    if (!rentalId) return;
    
    const rental = data.rentals.find(r => r.id === rentalId);
    const customer = data.customers.find(c => c.id === rental.customerId);
    
    rental.returnDate = new Date().toISOString().split('T')[0];
    rental.amount = parseFloat(document.getElementById('endRentalAmount').value);
    rental.paid = document.getElementById('endRentalPaid').checked;
    rental.returnNotes = document.getElementById('endRentalNotes').value;
    
    // ×¢×“×›×•×Ÿ ××›×©×™×¨
    const device = data.devices.find(d => d.id === rental.deviceId);
    device.status = 'available';
    device.revenue = (device.revenue || 0) + (rental.paid ? rental.amount : 0);
    
    // ×‘×“×™×§×ª ×¦×™×•×“ ×—×¡×¨
    const acc = rental.accessories || {};
    const missing = [];
    if (acc.cable && !document.getElementById('retCable')?.checked) missing.push('×›×‘×œ ×˜×¢×™× ×”');
    if (acc.caseBig && !document.getElementById('retCaseBig')?.checked) missing.push('× ×¨×ª×™×§ ×’×“×•×œ');
    if (acc.caseSmall && !document.getElementById('retCaseSmall')?.checked) missing.push('× ×¨×ª×™×§ ×§×˜×Ÿ');
    if (acc.carCharger && !document.getElementById('retCarCharger')?.checked) missing.push('××¦×ª ×œ×¨×›×‘');
    if (acc.magnet && !document.getElementById('retMagnet')?.checked) missing.push('××’× ×˜ ×œ×¨×›×‘');
    if (acc.arm && !document.getElementById('retArm')?.checked) missing.push('×–×¨×•×¢ ×œ×¨×›×‘');
    
    if (missing.length > 0) {
        customer.missingEquipment = (customer.missingEquipment || []).concat(missing);
        customer.equipmentPaid = 'pending';
        alert('âš ï¸ ×¦×™×•×“ ×—×¡×¨: ' + missing.join(', '));
    }
    
    // ×¢×“×›×•×Ÿ ×—×•×‘
    if (!rental.paid) {
        customer.debt = (customer.debt || 0) + rental.amount;
    }
    
    saveData();
    updateAll();
    closeModal('endRentalModal');
    alert('âœ… ×”×”×—×–×¨×” × ×¨×©××”!');
}

function cancelRental() {
    if (!confirm('×”×× ×œ×‘×˜×œ ××ª ×”×”×©×›×¨×”? (×”××›×©×™×¨ ×™×—×–×•×¨ ×œ×”×™×•×ª ×–××™×Ÿ)')) return;
    
    const rentalId = document.getElementById('endRentalSelect').value;
    if (!rentalId) return;
    
    const rental = data.rentals.find(r => r.id === rentalId);
    const device = data.devices.find(d => d.id === rental.deviceId);
    
    rental.returnDate = new Date().toISOString().split('T')[0];
    rental.cancelled = true;
    rental.amount = 0;
    rental.paid = true;
    
    device.status = 'available';
    
    saveData();
    updateAll();
    closeModal('endRentalModal');
    alert('âœ… ×”×”×©×›×¨×” ×‘×•×˜×œ×”');
}

function quickEndRental(rentalId) {
    document.getElementById('endRentalSelect').value = rentalId;
    showEndRentalDetails();
    openModal('endRentalModal');
}

// ×¢×¨×™×›×ª ×”×©×›×¨×”
function openEditRental(rentalId) {
    const rental = data.rentals.find(r => r.id === rentalId);
    const customer = data.customers.find(c => c.id === rental.customerId);
    
    document.getElementById('editRentalId').value = rentalId;
    document.getElementById('editRentalContent').innerHTML = `
        <div style="background:var(--light);padding:15px;border-radius:10px;margin-bottom:15px">
            <p><strong>×œ×§×•×—:</strong> ${customer?.name}</p>
            <p><strong>××›×©×™×¨:</strong> ${rental.deviceNumber}</p>
            <p><strong>×”×ª×—×œ×”:</strong> ${formatDate(rental.startDate)}</p>
        </div>
        <div class="form-group">
            <label>×ª××¨×™×š ×”×—×–×¨×”</label>
            <input type="date" id="editExpectedReturn" value="${rental.expectedReturn}">
        </div>
        <div class="form-group">
            <label>×”×•×¡×£ ×™××™×</label>
            <div style="display:flex;gap:10px">
                <button type="button" class="btn btn-primary btn-small" onclick="addDaysToRental(1)">+1</button>
                <button type="button" class="btn btn-primary btn-small" onclick="addDaysToRental(2)">+2</button>
                <button type="button" class="btn btn-primary btn-small" onclick="addDaysToRental(3)">+3</button>
                <button type="button" class="btn btn-primary btn-small" onclick="addDaysToRental(7)">+×©×‘×•×¢</button>
            </div>
        </div>
        <div class="form-group">
            <label>××—×™×¨ ×œ×™×•× (â‚ª)</label>
            <input type="number" id="editRentalPrice" value="${rental.price}">
        </div>
        <div class="form-group">
            <label>×”×¢×¨×•×ª</label>
            <textarea id="editRentalNotes" rows="2">${rental.notes || ''}</textarea>
        </div>
        <button class="btn btn-success" onclick="saveEditRental()">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
    `;
    
    openModal('editRentalModal');
}

function addDaysToRental(days) {
    const input = document.getElementById('editExpectedReturn');
    const current = new Date(input.value);
    current.setDate(current.getDate() + days);
    input.value = current.toISOString().split('T')[0];
}

function saveEditRental() {
    const rentalId = document.getElementById('editRentalId').value;
    const rental = data.rentals.find(r => r.id === rentalId);
    
    rental.expectedReturn = document.getElementById('editExpectedReturn').value;
    rental.price = parseFloat(document.getElementById('editRentalPrice').value);
    rental.notes = document.getElementById('editRentalNotes').value;
    
    saveData();
    updateAll();
    closeModal('editRentalModal');
    alert('âœ… ×”×©×™× ×•×™×™× × ×©××¨×•');
}

// ×¢××•×“ ×”×©×›×¨×•×ª
function updateRentalsPage(filter = 'active') {
    let filtered = data.rentals;
    
    switch(filter) {
        case 'active': filtered = data.rentals.filter(r => !r.returnDate); break;
        case 'overdue': filtered = data.rentals.filter(r => !r.returnDate && new Date(r.expectedReturn) < new Date()); break;
        case 'returned': filtered = data.rentals.filter(r => r.returnDate); break;
    }
    
    const container = document.getElementById('rentalsContainer');
    if (filtered.length === 0) {
        container.innerHTML = '<div class="alert alert-success">××™×Ÿ ×”×©×›×¨×•×ª ×‘×§×˜×’×•×¨×™×” ×–×•</div>';
        return;
    }
    
    container.innerHTML = filtered.map(r => {
        const customer = data.customers.find(c => c.id === r.customerId);
        const isOverdue = !r.returnDate && new Date(r.expectedReturn) < new Date();
        
        return `
        <div class="rental-card ${isOverdue ? 'overdue' : ''} ${r.returnDate ? 'returned' : ''}">
            <div class="rental-info">
                <h4>${customer?.name || '×œ×§×•×—'} - ××›×©×™×¨ ${r.deviceNumber} ${r.cancelled ? '(×‘×•×˜×œ)' : ''}</h4>
                <p>ğŸ“… ${formatDate(r.startDate)} ×¢×“ ${formatDate(r.expectedReturn)}</p>
                ${r.returnDate ? `<p>âœ… ×”×•×—×–×¨: ${formatDate(r.returnDate)}</p>` : ''}
                <p>ğŸ’° ${r.paid ? 'âœ… ×©×•×œ×' : 'âŒ ×œ× ×©×•×œ×'} - â‚ª${r.amount || r.price || 0}</p>
            </div>
            <div class="rental-actions">
                ${!r.returnDate ? `
                    <button class="btn btn-primary btn-small" onclick="openEditRental('${r.id}')">âœï¸</button>
                    <button class="btn btn-success btn-small" onclick="quickEndRental('${r.id}')">ğŸ“¥</button>
                ` : ''}
            </div>
        </div>`;
    }).join('');
}

function filterRentals(filter) {
    document.querySelectorAll('#rentals .tab').forEach(t => t.classList.remove('active'));
    if (event) event.target.classList.add('active');
    updateRentalsPage(filter);
}

// ××›×©×™×¨×™×
function updateDevicesTable(filter = 'all') {
    let filtered = data.devices;
    if (filter !== 'all') filtered = data.devices.filter(d => d.status === filter);
    
    document.getElementById('devicesTable').innerHTML = filtered.map(d => `
        <tr>
            <td><strong>${d.number}</strong></td>
            <td>${d.model || '-'}</td>
            <td>${d.screen || '-'}</td>
            <td>â‚ª${d.price || 10}</td>
            <td><span class="status ${d.status}">${getStatusName(d.status)}</span></td>
            <td>â‚ª${d.revenue || 0}</td>
            <td>
                <button class="btn btn-primary btn-small" onclick="editDevice('${d.id}')">âœï¸</button>
                <button class="btn btn-warning btn-small" onclick="toggleDeviceStatus('${d.id}')">ğŸ”„</button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="7" style="text-align:center">××™×Ÿ ××›×©×™×¨×™×</td></tr>';
}

function filterDevices(filter) {
    document.querySelectorAll('#devices .tab').forEach(t => t.classList.remove('active'));
    if (event) event.target.classList.add('active');
    updateDevicesTable(filter);
}

function getStatusName(status) {
    return {available: '×–××™×Ÿ', rented: '××•×©×›×¨', repair: '×‘×ª×™×§×•×Ÿ'}[status] || status;
}

function openDeviceModal(id = null) {
    document.getElementById('editDeviceId').value = id || '';
    document.getElementById('deviceModalTitle').textContent = id ? 'âœï¸ ×¢×¨×™×›×ª ××›×©×™×¨' : 'ğŸ“± ×”×•×¡×¤×ª ××›×©×™×¨';
    document.getElementById('deleteDeviceBtn').style.display = id ? 'inline-block' : 'none';
    
    if (id) {
        const d = data.devices.find(x => x.id === id);
        document.getElementById('deviceNumber').value = d.number || '';
        document.getElementById('deviceModel').value = d.model || '';
        document.getElementById('deviceType').value = d.type || 'standard';
        document.getElementById('deviceScreen').value = d.screen || '';
        document.getElementById('devicePrice').value = d.price || 10;
        document.getElementById('deviceUnlocked').value = d.unlocked || 'no';
        document.getElementById('deviceDonor').value = d.donor || '';
        document.getElementById('deviceNotes').value = d.notes || '';
    } else {
        document.getElementById('deviceNumber').value = '';
        document.getElementById('deviceModel').value = '';
        document.getElementById('deviceType').value = 'standard';
        document.getElementById('deviceScreen').value = '';
        document.getElementById('devicePrice').value = data.settings.defaultPrice || 10;
        document.getElementById('deviceUnlocked').value = 'no';
        document.getElementById('deviceDonor').value = '';
        document.getElementById('deviceNotes').value = '';
    }
    
    openModal('deviceModal');
}

function editDevice(id) {
    openDeviceModal(id);
}

function saveDevice(e) {
    e.preventDefault();
    const id = document.getElementById('editDeviceId').value;
    
    const deviceData = {
        number: document.getElementById('deviceNumber').value,
        model: document.getElementById('deviceModel').value,
        type: document.getElementById('deviceType').value,
        screen: document.getElementById('deviceScreen').value,
        price: parseFloat(document.getElementById('devicePrice').value) || 10,
        unlocked: document.getElementById('deviceUnlocked').value,
        donor: document.getElementById('deviceDonor').value,
        notes: document.getElementById('deviceNotes').value
    };
    
    if (id) {
        const device = data.devices.find(d => d.id === id);
        Object.assign(device, deviceData);
    } else {
        data.devices.push({
            id: Date.now().toString(),
            ...deviceData,
            status: 'available',
            revenue: 0
        });
    }
    
    saveData();
    updateAll();
    closeModal('deviceModal');
    return false;
}

function deleteDevice() {
    const id = document.getElementById('editDeviceId').value;
    if (!id) return;
    
    if (!confirm('×”×× ×œ××—×•×§ ××ª ×”××›×©×™×¨?')) return;
    
    data.devices = data.devices.filter(d => d.id !== id);
    saveData();
    updateAll();
    closeModal('deviceModal');
    alert('âœ… ×”××›×©×™×¨ × ××—×§');
}

function toggleDeviceStatus(id) {
    const device = data.devices.find(d => d.id === id);
    const statuses = ['available', 'repair', 'available'];
    if (device.status !== 'rented') {
        const idx = statuses.indexOf(device.status);
        device.status = statuses[(idx + 1) % 2];
        saveData();
        updateAll();
    }
}

// ×œ×§×•×—×•×ª
function updateCustomersTable(filter = 'all') {
    let filtered = data.customers;
    
    switch(filter) {
        case 'debt': filtered = data.customers.filter(c => c.debt > 0); break;
        case 'issues': filtered = data.customers.filter(c => c.missingEquipment?.length > 0); break;
    }
    
    document.getElementById('customersTable').innerHTML = filtered.map(c => {
        const issues = c.missingEquipment?.length > 0 ? c.missingEquipment.map(i => `<span class="accessory-tag missing">${i}</span>`).join('') : '-';
        return `
        <tr>
            <td><strong>${c.name}</strong></td>
            <td>${c.phone}</td>
            <td>${c.rentals || 0}</td>
            <td style="color:${c.debt > 0 ? 'var(--danger)' : 'var(--success)'}">â‚ª${c.debt || 0}</td>
            <td>${issues}</td>
            <td>${c.notes || '-'}</td>
            <td>
                <button class="btn btn-primary btn-small" onclick="editCustomer('${c.id}')">âœï¸</button>
            </td>
        </tr>`;
    }).join('') || '<tr><td colspan="7" style="text-align:center">××™×Ÿ ×œ×§×•×—×•×ª</td></tr>';
}

function filterCustomers(filter) {
    document.querySelectorAll('#customers .tab').forEach(t => t.classList.remove('active'));
    if (event) event.target.classList.add('active');
    updateCustomersTable(filter);
}

function openCustomerModal(id = null) {
    document.getElementById('editCustomerId').value = id || '';
    document.getElementById('customerModalTitle').textContent = id ? 'âœï¸ ×¢×¨×™×›×ª ×œ×§×•×—' : 'ğŸ‘¤ ×”×•×¡×¤×ª ×œ×§×•×—';
    document.getElementById('deleteCustomerBtn').style.display = id ? 'inline-block' : 'none';
    
    if (id) {
        const c = data.customers.find(x => x.id === id);
        document.getElementById('custName').value = c.name || '';
        document.getElementById('custPhone').value = c.phone || '';
        document.getElementById('custAddress').value = c.address || '';
        document.getElementById('custDebt').value = c.debt || 0;
        document.getElementById('custNotes').value = c.notes || '';
        
        const missing = c.missingEquipment || [];
        document.getElementById('custMissingCable').checked = missing.includes('×›×‘×œ ×˜×¢×™× ×”');
        document.getElementById('custMissingCase').checked = missing.includes('× ×¨×ª×™×§');
        document.getElementById('custDirtyCase').checked = c.dirtyCase || false;
        document.getElementById('custMissingCharger').checked = missing.includes('××¦×ª ×œ×¨×›×‘');
        document.getElementById('custMissingMagnet').checked = missing.includes('××’× ×˜ ×œ×¨×›×‘');
        document.getElementById('custMissingArm').checked = missing.includes('×–×¨×•×¢ ×œ×¨×›×‘');
        document.getElementById('custMissingOther').value = c.missingOther || '';
        document.getElementById('custEquipmentPaid').value = c.equipmentPaid || 'none';
    } else {
        document.getElementById('custName').value = '';
        document.getElementById('custPhone').value = '';
        document.getElementById('custAddress').value = '';
        document.getElementById('custDebt').value = 0;
        document.getElementById('custNotes').value = '';
        document.querySelectorAll('#customerModal input[type="checkbox"]').forEach(cb => cb.checked = false);
        document.getElementById('custMissingOther').value = '';
        document.getElementById('custEquipmentPaid').value = 'none';
    }
    
    openModal('customerModal');
}

function editCustomer(id) {
    openCustomerModal(id);
}

function saveCustomer(e) {
    e.preventDefault();
    const id = document.getElementById('editCustomerId').value;
    
    const missing = [];
    if (document.getElementById('custMissingCable').checked) missing.push('×›×‘×œ ×˜×¢×™× ×”');
    if (document.getElementById('custMissingCase').checked) missing.push('× ×¨×ª×™×§');
    if (document.getElementById('custMissingCharger').checked) missing.push('××¦×ª ×œ×¨×›×‘');
    if (document.getElementById('custMissingMagnet').checked) missing.push('××’× ×˜ ×œ×¨×›×‘');
    if (document.getElementById('custMissingArm').checked) missing.push('×–×¨×•×¢ ×œ×¨×›×‘');
    
    const customerData = {
        name: document.getElementById('custName').value,
        phone: document.getElementById('custPhone').value,
        address: document.getElementById('custAddress').value,
        debt: parseFloat(document.getElementById('custDebt').value) || 0,
        notes: document.getElementById('custNotes').value,
        missingEquipment: missing,
        dirtyCase: document.getElementById('custDirtyCase').checked,
        missingOther: document.getElementById('custMissingOther').value,
        equipmentPaid: document.getElementById('custEquipmentPaid').value
    };
    
    if (id) {
        const customer = data.customers.find(c => c.id === id);
        Object.assign(customer, customerData);
    } else {
        data.customers.push({
            id: Date.now().toString(),
            ...customerData,
            rentals: 0
        });
    }
    
    saveData();
    updateAll();
    closeModal('customerModal');
    return false;
}

function deleteCustomer() {
    const id = document.getElementById('editCustomerId').value;
    if (!id) return;
    if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×œ×§×•×—?')) return;
    
    data.customers = data.customers.filter(c => c.id !== id);
    saveData();
    updateAll();
    closeModal('customerModal');
}

// ×—×™×¤×•×© ×’×œ×•×‘×œ×™
function globalSearch(query) {
    if (!query || query.length < 2) return;
    query = query.toLowerCase();
    
    // ×—×™×¤×•×© ×‘×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª
    const rental = data.rentals.find(r => !r.returnDate && r.deviceNumber.toLowerCase().includes(query));
    if (rental) {
        filterRentals('active');
        showPage('rentals');
        return;
    }
    
    // ×—×™×¤×•×© ×‘×œ×§×•×—×•×ª
    const customer = data.customers.find(c => c.name.toLowerCase().includes(query) || c.phone.includes(query));
    if (customer) {
        showPage('customers');
        return;
    }
    
    // ×—×™×¤×•×© ×‘××›×©×™×¨×™×
    const device = data.devices.find(d => d.number.toLowerCase().includes(query));
    if (device) {
        showPage('devices');
    }
}

// ×“×•×—×•×ª
function generateReport() {
    const from = document.getElementById('reportFrom').value;
    const to = document.getElementById('reportTo').value;
    
    let filtered = data.rentals.filter(r => r.returnDate);
    if (from) filtered = filtered.filter(r => r.startDate >= from);
    if (to) filtered = filtered.filter(r => r.startDate <= to);
    
    const totalRevenue = filtered.filter(r => r.paid).reduce((sum, r) => sum + (r.amount || 0), 0);
    const totalRentals = filtered.length;
    
    document.getElementById('reportResults').innerHTML = `
        <div class="stats">
            <div class="stat-card success"><h3>â‚ª${totalRevenue}</h3><p>×”×›× ×¡×•×ª</p></div>
            <div class="stat-card"><h3>${totalRentals}</h3><p>×”×©×›×¨×•×ª</p></div>
            <div class="stat-card"><h3>â‚ª${totalRentals > 0 ? Math.round(totalRevenue/totalRentals) : 0}</h3><p>×××•×¦×¢</p></div>
        </div>
    `;
}

// ×™×™×¦×•× ×œ××§×¡×œ
function exportToExcel(type) {
    let csvContent = '\ufeff'; // BOM for Hebrew
    
    if (type === 'devices') {
        csvContent += '××¡×¤×¨,×“×’×,×¡×•×’,×’×•×“×œ ××¡×š,××—×™×¨,×¡×˜×˜×•×¡,×”×›× ×¡×•×ª\n';
        data.devices.forEach(d => {
            csvContent += `${d.number},${d.model || ''},${d.type || ''},${d.screen || ''},${d.price || 10},${getStatusName(d.status)},${d.revenue || 0}\n`;
        });
    } else if (type === 'customers') {
        csvContent += '×©×,×˜×œ×¤×•×Ÿ,×”×©×›×¨×•×ª,×—×•×‘,×”×¢×¨×•×ª\n';
        data.customers.forEach(c => {
            csvContent += `${c.name},${c.phone},${c.rentals || 0},${c.debt || 0},${c.notes || ''}\n`;
        });
    }
    
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gmach-${type}-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

// ×”×’×“×¨×•×ª
function loadSettings() {
    const s = data.settings;
    document.getElementById('defaultPrice').value = s.defaultPrice || 10;
    document.getElementById('defaultDays').value = s.defaultDays || 1;
    document.getElementById('lateFee').value = s.lateFee || 5;
    document.getElementById('appPassword').value = s.password || '';
    document.getElementById('ownerName').value = s.ownerName || '';
    document.getElementById('ownerPhone').value = s.ownerPhone || '';
    document.getElementById('ownerCity').value = s.ownerCity || '';
    document.getElementById('ownerDedication').value = s.ownerDedication || '';
    
    const def = s.defaultAccessories || {};
    document.getElementById('defCable').checked = def.cable || false;
    document.getElementById('defCaseBig').checked = def.caseBig || false;
    document.getElementById('defCaseSmall').checked = def.caseSmall || false;
    document.getElementById('defCarCharger').checked = def.carCharger || false;
    document.getElementById('defMagnet').checked = def.magnet || false;
    document.getElementById('defArm').checked = def.arm || false;
}

function saveSettings() {
    data.settings = {
        defaultPrice: parseFloat(document.getElementById('defaultPrice').value) || 10,
        defaultDays: parseInt(document.getElementById('defaultDays').value) || 1,
        lateFee: parseFloat(document.getElementById('lateFee').value) || 5,
        password: document.getElementById('appPassword').value,
        ownerName: document.getElementById('ownerName').value,
        ownerPhone: document.getElementById('ownerPhone').value,
        ownerCity: document.getElementById('ownerCity').value,
        ownerDedication: document.getElementById('ownerDedication').value,
        defaultAccessories: {
            cable: document.getElementById('defCable').checked,
            caseBig: document.getElementById('defCaseBig').checked,
            caseSmall: document.getElementById('defCaseSmall').checked,
            carCharger: document.getElementById('defCarCharger').checked,
            magnet: document.getElementById('defMagnet').checked,
            arm: document.getElementById('defArm').checked
        }
    };
    saveData();
    alert('âœ… ×”×”×’×“×¨×•×ª × ×©××¨×•!');
}

// ×™×™×¦×•×/×™×™×‘×•×
function exportData() {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gmach-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function importData(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            data = JSON.parse(event.target.result);
            saveData();
            updateAll();
            loadSettings();
            alert('âœ… ×”× ×ª×•× ×™× ×™×•×‘××• ×‘×”×¦×œ×—×”!');
        } catch (err) {
            alert('âŒ ×©×’×™××” ×‘×™×™×‘×•×');
        }
    };
    reader.readAsText(file);
}

// ××•×“×œ×™×
function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
    });
});

// ××ª×—×•×œ
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    loadDefaultAccessories();
    
    // ×‘×¨×™×¨×ª ××—×“×œ ×œ×™××™×
    const defaultDays = data.settings.defaultDays || 1;
    document.getElementById('rentalDuration').value = defaultDays.toString();
});
</script>
</body>
</html>
